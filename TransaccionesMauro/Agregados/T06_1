[{"$match":{"$expr":{"$eq":["$fechaProceso",{"$toDate":"@fechaProceso"}]}}},{"$addFields":{"sumCreditsOverdueRestructured":{"$sum":["$restructuredLoans1","$overdueLoans1"]}}},{"$addFields":{"sumProvisionForLoanOverGrossLoan":{"$sum":["$currentLoans1","$restructuredLoans1","$overdueLoans1","$litigationLoans1"]}}},{"$addFields":{"sumLoanDelincuency":{"$cond":[{"$eq":["$sumProvisionForLoanOverGrossLoan",0]},0,{"$divide":["$sumCreditsOverdueRestructured","$sumProvisionForLoanOverGrossLoan"]}]}}},{"$addFields":{"sumFinancialIntermediation":{"$cond":[{"$eq":["$publicDeposits",0]},0,{"$divide":["$sumProvisionForLoanOverGrossLoan","$publicDeposits"]}]}}},{"$addFields":{"sumPublicDepositsNationalCurrency":{"$subtract":[{"$subtract":[{"$ifNull":["$publicDeposits",0]},{"$ifNull":["$exchangeAgreementNo20CheckingAccounts",0]}]},{"$subtract":[{"$ifNull":["$freeExchangeSystemCheckingAccounts",0]},{"$ifNull":["$specialTrustFundsFreeExchangeSystem",0]}]}]}}},{"$addFields":{"sumTotalEquity":{"$sum":["$totalEquity","$operationalManagement"]},"sumPrivateDepositsNationalCurrency":{"$subtract":[{"$ifNull":["$sumPublicDepositsNationalCurrency",0]},{"$ifNull":["$officialEntityDeposits1",0]}]}}},{"$group":{"_id":{"fechaProceso":"$fechaProceso"},"globalLitigationLoans1":{"$sum":"$litigationLoans1"},"globalTotalAssets":{"$sum":"$totalAssets"},"globalPublicDeposits":{"$sum":"$publicDeposits"},"globalFreeExchangeSystemCheckingAccounts":{"$sum":"$freeExchangeSystemCheckingAccounts"},"globalProvisionForLoanOverGrossLoan":{"$sum":"$sumProvisionForLoanOverGrossLoan"},"globalOfficialEntityDeposits1":{"$sum":"$officialEntityDeposits1"},"globalTotalEquity":{"$sum":"$sumTotalEquity"},"globalIncomeFromLoanPortfolio":{"$sum":"$incomeFromLoanPortfolio"},"globalOtherOperatingIncome":{"$sum":"$otherOperatingIncome"},"globalNetResult2":{"$sum":"$netResult2"},"globalPublicDepositsNationalCurrency":{"$sum":"$sumPublicDepositsNationalCurrency"},"globalPrivateDepositsNationalCurrency":{"$sum":"$sumPrivateDepositsNationalCurrency"},"globalLoanDelincuency":{"$sum":"$sumLoanDelincuency"},"globalFinancialIntermediation":{"$sum":"$sumFinancialIntermediation"},"globalOverdueLoans1":{"$sum":"$overdueLoans1"},"name":{"$addToSet":"$name"}}},{"$addFields":{"fechaProceso":"$_id.fechaProceso","_id":"$$REMOVE"}},{"$lookup":{"from":"sidis_tasaconversion","localField":"fechaProceso","foreignField":"Fecha","as":"result"}},{"$addFields":{"tasaDolar":{"$arrayElemAt":["$result.Tasa_DOL",0]},"tasaEuro":{"$arrayElemAt":["$result.Tasa_EUR",0]},"factorConversion":{"$arrayElemAt":["$result.Conversion",0]}}},{"$addFields":{"globalLitigationLoans1USD":{"$divide":["$globalLitigationLoans1","$tasaDolar"]},"globalTotalAssetsUSD":{"$divide":["$globalTotalAssets","$tasaDolar"]},"globalProvisionForLoanOverGrossLoanUSD":{"$divide":["$globalProvisionForLoanOverGrossLoan","$tasaDolar"]},"globalFreeExchangeSystemCheckingAccountsUSD":{"$divide":["$globalFreeExchangeSystemCheckingAccounts","$tasaDolar"]},"globalOfficialEntityDeposits1USD":{"$divide":["$globalOfficialEntityDeposits1","$tasaDolar"]},"globalTotalEquityUSD":{"$divide":["$globalTotalEquity","$tasaDolar"]},"globalIncomeFromLoanPortfolioUSD":{"$divide":["$globalIncomeFromLoanPortfolio","$tasaDolar"]},"globalOtherOperatingIncomeUSD":{"$divide":["$globalOtherOperatingIncome","$tasaDolar"]},"globalNetResult2USD":{"$divide":["$globalNetResult2","$tasaDolar"]},"globalPublicDepositsUSD":{"$divide":["$globalPublicDeposits","$tasaDolar"]},"globalPublicDepositsNationalCurrencyUSD":{"$divide":["$globalPublicDepositsNationalCurrency","$tasaDolar"]},"globalPrivateDepositsNationalCurrencyUSD":{"$divide":["$globalPrivateDepositsNationalCurrency","$tasaDolar"]},"globalLoanDelincuencyUSD":{"$divide":["$globalLoanDelincuency","$tasaDolar"]},"globalFinancialIntermediationUSD":{"$divide":["$globalFinancialIntermediation","$tasaDolar"]},"globalOverdueLoans1USD":{"$divide":["$globalOverdueLoans1","$tasaDolar"]}}},{"$unwind":{"path":"$name"}},{"$project":{"globalLitigationLoans1":1,"globalTotalAssets":1,"globalProvisionForLoanOverGrossLoan":1,"globalFreeExchangeSystemCheckingAccounts":1,"globalOfficialEntityDeposits1":1,"globalTotalEquity":1,"globalIncomeFromLoanPortfolio":1,"globalOtherOperatingIncome":1,"globalNetResult2":1,"globalPublicDeposits":1,"globalPublicDepositsNationalCurrency":1,"globalPrivateDepositsNationalCurrency":1,"globalLoanDelincuency":1,"globalFinancialIntermediation":1,"globalOverdueLoans1":1,"name":1,"fechaProceso":1,"globalLitigationLoans1USD":1,"globalTotalAssetsUSD":1,"globalProvisionForLoanOverGrossLoanUSD":1,"globalFreeExchangeSystemCheckingAccountsUSD":1,"globalOfficialEntityDeposits1USD":1,"globalTotalEquityUSD":1,"globalIncomeFromLoanPortfolioUSD":1,"globalOtherOperatingIncomeUSD":1,"globalNetResult2USD":1,"globalPublicDepositsUSD":1,"globalPublicDepositsNationalCurrencyUSD":1,"globalPrivateDepositsNationalCurrencyUSD":1,"globalLoanDelincuencyUSD":1,"globalFinancialIntermediationUSD":1,"globalOverdueLoans1USD":1}},{"$merge":{"into":"sidis_Financialstatement","on":["fechaProceso","name"]}}]