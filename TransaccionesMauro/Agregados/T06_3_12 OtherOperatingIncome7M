[{"$addFields":{"fechaSuperior":{"$dateFromParts":{"year":{"$year":{"$toDate":"@fechaProceso"}},"month":{"$month":{"$toDate":"@fechaProceso"}}}},"month":{"$month":{"$toDate":"@fechaProceso"}}}},{"$addFields":{"fechaProcesoAct":{"$dateFromParts":{"year":{"$year":"$fechaProceso"},"month":{"$month":"$fechaProceso"}}},"fechaInferior":{"$dateSubtract":{"startDate":{"$dateFromParts":{"year":{"$year":"$fechaSuperior"},"month":{"$month":"$fechaSuperior"}}},"unit":"month","amount":{"$subtract":["$month",1]}}}}},{"$match":{"$and":[{"$expr":{"$gte":["$fechaProcesoAct","$fechaInferior"]}},{"$expr":{"$lte":["$fechaProcesoAct","$fechaSuperior"]}}]}},{"$group":{"_id":null,"globalOtherOperatingIncome7MUSD":{"$sum":"$globalOtherOperatingIncomeUSD"},"fechaProceso":{"$max":"$fechaProceso"},"fechaProcesoInicio":{"$min":"$fechaProceso"},"name":{"$addToSet":"$name"},"banks":{"$addToSet":{"name":"$name","fechaProceso":"$fechaProceso","otherOperatingIncome":{"$sum":"$otherOperatingIncome"}}}}},{"$unwind":{"path":"$banks"}},{"$lookup":{"from":"sidis_tasaconversion","localField":"banks.fechaProceso","foreignField":"Fecha","as":"result"}},{"$addFields":{"banks.otherOperatingIncomeUSD":{"$round":[{"$divide":["$banks.otherOperatingIncome",{"$arrayElemAt":["$result.Tasa_DOL",0]}]},4]},"result":"$$REMOVE"}},{"$lookup":{"from":"sidis_Financialstatement","let":{"fechaProceso":"$banks.fechaProceso","name":"$banks.name"},"pipeline":[{"$match":{"$expr":{"$and":[{"$eq":["$fechaProceso","$$fechaProceso"]},{"$eq":["$name","$$name"]}]}}}],"as":"result"}},{"$addFields":{"banks.globalOtherOperatingIncomeUSD":{"$arrayElemAt":["$result.globalOtherOperatingIncomeUSD",0]},"banks.gFechaProceso":"$fechaProceso","result":"$$REMOVE"}},{"$group":{"_id":{"name":"$banks.name"},"otherOperatingIncome7M":{"$sum":"$banks.otherOperatingIncome"},"otherOperatingIncome7MUSD":{"$sum":"$banks.otherOperatingIncomeUSD"},"globalOtherOperatingIncome7MUSD":{"$addToSet":{"value":"$banks.globalOtherOperatingIncomeUSD"}},"fechaProceso":{"$first":"$banks.fechaProceso"},"gfechaProceso":{"$first":"$banks.gFechaProceso"}}},{"$addFields":{"name":"$_id.name","_id":"$$REMOVE","globalOtherOperatingIncome7MUSD":{"$round":[{"$sum":"$globalOtherOperatingIncome7MUSD.value"},4]}}},{"$group":{"_id":{"name":"$name","fechaProceso":"$fechaProceso"},"otherOperatingIncome7M":{"$sum":"$otherOperatingIncome7M"},"otherOperatingIncome7MUSD":{"$sum":"$otherOperatingIncome7MUSD"},"globalOtherOperatingIncome7MUSD":{"$first":"$globalOtherOperatingIncome7MUSD"},"fechaProceso":{"$first":"$gfechaProceso"}}},{"$addFields":{"resultOtherOperatingIncome7MUSD":{"$round":[{"$divide":[{"$multiply":["$otherOperatingIncome7MUSD",100]},"$globalOtherOperatingIncome7MUSD"]},5]}}},{"$sort":{"resultOtherOperatingIncome7MUSD":-1}},{"$project":{"fechaProceso":"$fechaProceso","name":"$_id.name","resultOtherOperatingIncome7MUSD":1,"otherOperatingIncome7M":1,"otherOperatingIncome7MUSD":1,"globalOtherOperatingIncome7MUSD":1,"_id":0}},{"$group":{"_id":{"fechaProceso":"$fechaProceso"},"otherOperatingIncome_ac":{"$push":{"name":"$name","prctValue":"$resultOtherOperatingIncome7MUSD","amountBsValue":"$otherOperatingIncome7M","amountUsdValue":"$otherOperatingIncome7MUSD","globalValue":"$globalOtherOperatingIncome7MUSD"}}}},{"$addFields":{"fechaProceso":"$_id.fechaProceso","_id":"$$REMOVE"}},{"$merge":{"into":"Financialstatementdashboard","on":"fechaProceso"}}]