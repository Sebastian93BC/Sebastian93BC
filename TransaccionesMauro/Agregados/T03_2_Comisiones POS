[{"$match":{"$and":[{"$expr":{"$eq":["$fechaProceso",{"$toDate":"@fechaProceso"}]}},{"nro_pos":{"$ne":"00000"}}]}},{"$lookup":{"from":"sidis_parametrica_comisionesTx","localField":"fechaProceso","foreignField":"fechaProceso","as":"result"}},{"$addFields":{"factor":{"$arrayElemAt":["$result.costoTXBolivares",0]}}},{"$group":{"_id":{"rifCedula":"$rifCedula","fechaProceso":"$fechaProceso"},"comisionDebito":{"$sum":{"$add":[{"$multiply":["$liq_mto_debito_bdv",{"$divide":["$tasa_debito",100]}]},{"$multiply":["$liq_mto_debito_n_bdv",{"$divide":[{"$subtract":["$tasa_debito","$tasa_compensac_debito"]},100]}]},{"$multiply":["$liq_mto_electron",{"$divide":["$tasa_electron",100]}]}]}},"comisionCredito":{"$sum":{"$add":[{"$multiply":["$liq_mto_credito_bdv",{"$divide":["$tasa_credito",100]}]},{"$multiply":["$liq_mto_credito_n_bdv",{"$divide":[{"$subtract":["$tasa_credito","$tasa_compensac_credito"]},100]}]}]}},"costoTx":{"$sum":{"$multiply":[{"$multiply":[{"$add":["$liq_tran_debito_bdv","$liq_tran_debito_n_bdv","$liq_tran_credito_bdv","$liq_tran_credito_n_bdv","$liq_tran_electron"]},"$factor"]},1.16]}}}},{"$addFields":{"comisionPos":{"$round":[{"$subtract":[{"$add":["$comisionDebito","$comisionCredito"]},"$costoTx"]},4]}}},{"$project":{"rifCedula":"$_id.rifCedula","fechaProceso":"$_id.fechaProceso","posComisionesBolivares":"$comisionPos","_id":0}},{"$lookup":{"from":"sidis_tasaconversion","localField":"fechaProceso","foreignField":"Fecha","as":"result"}},{"$addFields":{"posComisionesDolares":{"$round":[{"$divide":["$posComisionesBolivares",{"$arrayElemAt":["$result.Tasa_DOL",0]}]},4]},"posComisionesEuros":{"$round":[{"$divide":["$posComisionesBolivares",{"$arrayElemAt":["$result.Tasa_EUR",0]}]},4]},"tasaDolar":{"$arrayElemAt":["$result.Tasa_DOL",0]},"tasaEuro":{"$arrayElemAt":["$result.Tasa_EUR",0]}}},{"$project":{"result":0}},{"$merge":{"into":"sidis_ingresoComisiones","on":["fechaProceso","rifCedula"]}}]