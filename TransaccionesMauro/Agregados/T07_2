[{"$group":{"_id":{"numSolicitud":"$numSolicitud"},"operationStatus":{"$max":"$codigoEstado"},"transactionDate":{"$min":"$fechaSolicitud"},"operationStatusName":{"$max":"$estado"},"file_date":{"$max":"$file_date"},"altairIdentification":{"$max":"$identificacion"},"saleAmountApproved":{"$max":"$montoAprobado"},"saleAmount":{"$max":"$montoSolictado"},"nationality":{"$max":"$nacionalidad"},"producto":{"$max":"$producto"},"vat":{"$max":"$rifCedula"},"createdAt":{"$min":"$fechaSolicitud"},"updatedAt":{"$max":"$file_date"}}},{"$addFields":{"externalCode":"$_id.numSolicitud","_id":"$$REMOVE","phase":{"$switch":{"branches":[{"case":{"$in":["$operationStatus",["001"]]},"then":"qualified"},{"case":{"$in":["$operationStatus",["004","010"]]},"then":"applicationQualified"},{"case":{"$in":["$operationStatus",["017","023","036","029","039"]]},"then":"open"},{"case":{"$in":["$operationStatus",["009","007","043","044","031","060","019"]]},"then":"stopped"},{"case":{"$in":["$operationStatus",["005","013"]]},"then":"creditApproved"},{"case":{"$in":["$operationStatus",["006"]]},"then":"lost"},{"case":{"$in":["$operationStatus",["012"]]},"then":"openContrac"},{"case":{"$in":["$operationStatus",["018"]]},"then":"documentsReceived"},{"case":{"$in":["$operationStatus",["020","022"]]},"then":"liquidatedOnProcess"},{"case":{"$in":["$operationStatus",["033"]]},"then":"stopped"},{"case":{"$in":["$operationStatus",["061","015","014"]]},"then":"creditLiquidated"},{"case":{"$in":["$operationStatus",["025","042","021"]]},"then":"closed"}],"default":"notMapped"}},"type":"financing","financingType":"crediEmprendeBDV","productName":"CREDIEMPRENDEBDV","productCode":329,"status":{"$switch":{"branches":[{"case":{"$in":["$operationStatus",["001","004","010","017","023","036","029","039","005","013","012","018","020","022","033","061","015","014","060","039"]]},"then":"open"},{"case":{"$in":["$operationStatus",["061","015","014"]]},"then":"won"},{"case":{"$in":["$operationStatus",["006","025","042","021"]]},"then":"lost"}],"default":"open"}},"operationStatusName":{"$switch":{"branches":[{"case":{"$eq":["$operationStatus","001"]},"then":"001-Recepcionyrevisiondeexpendiente"},{"case":{"$eq":["$operationStatus","004"]},"then":"004-Expedienteenviadoacomit√©"},{"case":{"$eq":["$operationStatus","017"]},"then":"017-ExpsinDecisionenesperaderecaudos"},{"case":{"$eq":["$operationStatus","009"]},"then":"009-ExpedienteenviadoOficina"},{"case":{"$eq":["$operationStatus","023"]},"then":"023-Reconsideracion"},{"case":{"$eq":["$operationStatus","036"]},"then":"036-RecibidaporRiesgo"},{"case":{"$eq":["$operationStatus","005"]},"then":"005-Aprobado"},{"case":{"$eq":["$operationStatus","006"]},"then":"006negado"},{"case":{"$eq":["$operationStatus","007"]},"then":"007-Diferido"},{"case":{"$eq":["$operationStatus","012"]},"then":"012-Enelaboraciondecontrato"},{"case":{"$eq":["$operationStatus","043"]},"then":"043-Negadodevueltooficina"},{"case":{"$eq":["$operationStatus","044"]},"then":"044-Diferidodevueltoaoficina"},{"case":{"$eq":["$operationStatus","029"]},"then":"029-DocumentoenVisado"},{"case":{"$eq":["$operationStatus","013"]},"then":"013-Contratoenviadoaoficina"},{"case":{"$eq":["$operationStatus","010"]},"then":"010-Exp.aprobadoesperarecaudos"},{"case":{"$eq":["$operationStatus","018"]},"then":"018-DocumentoRecibidoenSFP"},{"case":{"$eq":["$operationStatus","020"]},"then":"020-Expedienteenviadoporliquidar"},{"case":{"$eq":["$operationStatus","022"]},"then":"022-Liquidacionconfianza"},{"case":{"$eq":["$operationStatus","031"]},"then":"031-Documentomalelaborado"},{"case":{"$eq":["$operationStatus","033"]},"then":"033-Porliquidar,fallarecsolr"},{"case":{"$eq":["$operationStatus","061"]},"then":"061-Liquidaoportfinanciero"},{"case":{"$eq":["$operationStatus","015"]},"then":"015-Creditoliquidado"},{"case":{"$eq":["$operationStatus","014"]},"then":"014-DTOSCOMPLEM/TIT.EMPL.OTROS"},{"case":{"$eq":["$operationStatus","039"]},"then":"039-Errorenliquidacion"},{"case":{"$eq":["$operationStatus","025"]},"then":"025-CodigoPuente"},{"case":{"$eq":["$operationStatus","042"]},"then":"042-Desistido"},{"case":{"$eq":["$operationStatus","019"]},"then":"019-IncidenciaenFirma"},{"case":{"$eq":["$operationStatus","021"]},"then":"021-CreditoVencido"}],"default":"Paraotroscodigos"}}}},{"$lookup":{"from":"Potential","localField":"vat","foreignField":"vat","as":"result"}},{"$addFields":{"buyerId":{"$arrayElemAt":["$result._id",0]},"buyerName":{"$arrayElemAt":["$result.name",0]},"buyerEmail":{"$arrayElemAt":["$result.email",0]},"officeCode":{"$arrayElemAt":["$result.officeCode",0]},"officeName":{"$arrayElemAt":["$result.officeName",0]},"businessAgentId":{"$arrayElemAt":["$result.businessAgentId",0]},"businessAgentName":{"$arrayElemAt":["$result.businessAgentName",0]},"businessSpecialistId":{"$arrayElemAt":["$result.businessSpecialistId",0]},"businessSpecialistName":{"$arrayElemAt":["$result.businessSpecialistName",0]},"businessManagerId":{"$arrayElemAt":["$result.businessManagerId",0]},"businessManagerName":{"$arrayElemAt":["$result.businessManagerName",0]},"trainingAnalistId":{"$arrayElemAt":["$result.trainingAnalistId",0]},"trainingAnalistName":{"$arrayElemAt":["$result.trainingAnalistName",0]},"trainingSpecialistId":{"$arrayElemAt":["$result.trainingSpecialistId",0]},"trainingSpecialistName":{"$arrayElemAt":["$result.trainingSpecialistName",0]},"trainingManagerId":{"$arrayElemAt":["$result.trainingManagerId",0]},"trainingManagerName":{"$arrayElemAt":["$result.trainingManagerName",0]},"ownerId":{"$arrayElemAt":["$result.ownerId",0]},"ownerName":{"$arrayElemAt":["$result.ownerName",0]},"assignedId":{"$arrayElemAt":["$result.assignedId",0]},"assignedName":{"$arrayElemAt":["$result.assignedName",0]},"regionId":{"$arrayElemAt":["$result.regionId",0]},"regionName":{"$arrayElemAt":["$result.regionName",0]},"department":{"$arrayElemAt":["$result.department",0]},"visepresidency":{"$arrayElemAt":["$result.visepresidency",0]},"result":"$$REMOVE"}},{"$lookup":{"from":"Office","localField":"officeCode","foreignField":"internalCode","as":"result"}},{"$addFields":{"officeId":{"$arrayElemAt":["$result._id",0]},"result":"$$REMOVE"}},{"$lookup":{"from":"Product","localField":"producto","foreignField":"name","as":"result"}},{"$addFields":{"productId":{"$arrayElemAt":["$result._id",0]},"productName":{"$arrayElemAt":["$result.name",0]},"productCode":{"$arrayElemAt":["$result.internalCode",0]},"productEntityCode":{"$arrayElemAt":["$result.entityCode",0]},"productInternalType":{"$arrayElemAt":["$result.internalType",0]},"productInternalNatCode":{"$arrayElemAt":["$result.internalNatCode",0]},"integrationIds.vgp":"$externalCode","subject":{"$concat":["CREDIEMPRENDE-","$buyerName"]},"producto":"$$REMOVE","result":"$$REMOVE","history":"$$REMOVE"}},{"$merge":{"into":"Transaction","on":"externalCode"}}]