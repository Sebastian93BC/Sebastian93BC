[{"$match":{"$and":[{"$expr":{"$gte":["$tra_fecha_operacion",{"$toDate":"2023-11-01"}]}},{"$expr":{"$lte":["$tra_fecha_operacion",{"$toDate":"2023-11-30"}]}}]}},{"$group":{"_id":{"tra_cod_op":"$tra_cod_op","tra_nro_mov":"$tra_nro_mov","tra_cuenta_contrato":"$tra_cuenta_contrato","tra_fecha_contable":"$tra_fecha_contable"},"tra_fecha_operacion":{"$first":"$tra_fecha_operacion"}}},{"$addFields":{"fechaProceso":{"$toDate":"2023-11-30"},"_id":"$$REMOVE"}},{"$group":{"_id":{"fechaProceso":"$fechaProceso","tra_fecha_operacion":"$tra_fecha_operacion"},"baseCollectionCount":{"$sum":1}}},{"$group":{"_id":{"fechaProceso":"$_id.fechaProceso"},"results":{"$addToSet":{"date":"$_id.tra_fecha_operacion","count":"$baseCollectionCount"}}}},{"$addFields":{"processDate":"$_id.fechaProceso","recipeCode":"T00","createdAt":"$$NOW","processName":"Transaferencia Transacciones","kpi":[{"name":"Transacciones","tra_fecha_operacion":"$_id.tra_fecha_operacion","baseCollectionCount":"$results","baseCollection":"rawTransacciones","toCollection":"sidis_transacciones"}],"_id":"$$REMOVE","results":"$$REMOVE"}},{"$lookup":{"from":"sidis_consistencyData","let":{"fechaProcesoLookup":"$processDate","codeLookup":"$recipeCode"},"pipeline":[{"$match":{"$expr":{"$and":[{"$eq":["$processDate","$$fechaProcesoLookup"]},{"$eq":["$recipeCode","$$codeLookup"]}]}}},{"$project":{"kpi":1}}],"as":"resultados"}},{"$addFields":{"found":{"$filter":{"input":"$resultados.kpi","as":"arregloSecundario","cond":{"$eq":["Transacciones","$$arregloSecundario.name"]}}}}},{"$addFields":{"resultados":{"$concatArrays":["$resultados.kpi","$kpi"]}}},{"$project":{"processDate":1,"recipeCode":1,"createdAt":"$$NOW","kpi":"$resultados","_id":0}},{"$merge":{"into":"sidis_consistencyData","on":["processDate","recipeCode"]}}]