[{"$match":{"$and":[{"$expr":{"$eq":["$tra_fecha_operacion",{"$toDate":"@fechaProceso"}]}},{"$expr":{"$eq":[{"$substr":["$tra_rif",8,-1]},"9"]}},{"tra_banca":{"$nin":["5",5,"4",4,"0",0,"1",1]}}]}},{"$addFields":{"fechaProceso":{"$dateFromParts":{"year":{"$year":"$tra_fecha_operacion"},"month":{"$add":[{"$month":"$tra_fecha_operacion"},1]},"day":{"$subtract":[{"$dayOfMonth":{"$dateFromParts":{"year":{"$year":"$tra_fecha_operacion"},"month":{"$add":[{"$month":"$tra_fecha_operacion"},1]},"day":1}}},1]},"hour":0,"minute":0,"second":0,"millisecond":0}},"primeraLetraRif":{"$substr":["$tra_rif",0,1]},"ultimaLetraRif":{"$substr":["$tra_rif",8,-1]}}},{"$group":{"_id":{"tra_fecha_contable":"$tra_fecha_contable","tra_cod_op":"$tra_cod_op","tra_nro_mov":"$tra_nro_mov","tra_cuenta_contrato":"$tra_cuenta_contrato"},"fechaProceso":{"$first":"$fechaProceso"},"tra_entidad":{"$first":"$tra_entidad"},"tra_oficina_operante":{"$first":"$tra_oficina_operante"},"tra_oficina_origen":{"$first":"$tra_oficina_origen"},"tra_oficina_destino":{"$first":"$tra_oficina_destino"},"tra_desc_oficina":{"$first":"$tra_desc_oficina"},"tra_canal":{"$first":"$tra_canal"},"tra_desc_canal":{"$first":"$tra_desc_canal"},"tra_usuario":{"$first":"$tra_usuario"},"tra_cargo":{"$first":"$tra_cargo"},"tra_fecha_hora":{"$first":"$tra_fecha_hora"},"tra_transaccion":{"$first":"$tra_transaccion"},"tra_desc_transaccion":{"$first":"$tra_desc_transaccion"},"tra_oper_valida":{"$first":"$tra_oper_valida"},"tra_terminal":{"$first":"$tra_terminal"},"tra_desc_cod_op":{"$first":"$tra_desc_cod_op"},"tra_aplicacion_origen":{"$first":"$tra_aplicacion_origen"},"tra_aplicacion_destino":{"$first":"$tra_aplicacion_destino"},"tra_cod_interfa":{"$first":"$tra_cod_interfa"},"tra_serial_de_operacion":{"$first":"$tra_serial_de_operacion"},"tra_sector_economico":{"$first":"$tra_sector_economico"},"tra_desc_sector_economico":{"$first":"$tra_desc_sector_economico"},"tra_ind_juridico_fisico":{"$first":"$tra_ind_juridico_fisico"},"tra_fecha_operacion":{"$first":"$tra_fecha_operacion"},"tra_tipo_taquilla":{"$first":"$tra_tipo_taquilla"},"tra_terminal_fisico":{"$first":"$tra_terminal_fisico"},"tra_varios_ristra":{"$first":"$tra_varios_ristra"},"tra_tasa2":{"$first":"$tra_tasa2"},"tra_monto_comision":{"$first":"$tra_monto_comision"},"tra_cuenta_contable2":{"$first":"$tra_cuenta_contable2"},"tra_rif":{"$first":"$tra_rif"},"tra_producto":{"$first":"$tra_producto"},"tra_banca":{"$first":"$tra_banca"},"tra_segmento":{"$first":"$tra_segmento"},"cuentaContable":{"$push":{"tra_ind_cre_deb":"$tra_ind_cre_deb","tra_cuenta_contable":"$tra_cuenta_contable"}},"ristraContable":{"$push":{"tra_ind_cre_deb":"$tra_ind_cre_deb","tra_ristra_contable":"$tra_ristra_contable"}},"monto":{"$sum":"$tra_monto_debe"}}},{"$addFields":{"tra_cod_op":"$_id.tra_cod_op","tra_nro_mov":"$_id.tra_nro_mov","tra_cuenta_contrato":"$_id.tra_cuenta_contrato","tra_fecha_contable":"$_id.tra_fecha_contable","cuentaContableHaber":{"$let":{"vars":{"haber":{"$arrayElemAt":["$cuentaContable.tra_cuenta_contable",{"$indexOfArray":["$cuentaContable.tra_ind_cre_deb","C"]}]}},"in":{"$cond":{"if":{"$ne":["$$haber",null]},"then":"$$haber","else":null}}}},"cuentaContableDebe":{"$let":{"vars":{"debe":{"$arrayElemAt":["$cuentaContable.tra_cuenta_contable",{"$indexOfArray":["$cuentaContable.tra_ind_cre_deb","D"]}]}},"in":{"$cond":{"if":{"$ne":["$$debe",null]},"then":"$$debe","else":null}}}},"ristraContableHaber":{"$let":{"vars":{"haber":{"$arrayElemAt":["$ristraContable.tra_ristra_contable",{"$indexOfArray":["$ristraContable.tra_ind_cre_deb","C"]}]}},"in":{"$cond":{"if":{"$ne":["$$haber",null]},"then":"$$haber","else":null}}}},"ristraContableDebe":{"$let":{"vars":{"debe":{"$arrayElemAt":["$ristraContable.tra_ristra_contable",{"$indexOfArray":["$ristraContable.tra_ind_cre_deb","D"]}]}},"in":{"$cond":{"if":{"$ne":["$$debe",null]},"then":"$$debe","else":null}}}},"ristraContableHaberMoneda":{"$let":{"vars":{"haber":{"$arrayElemAt":["$ristraContable.tra_ristra_contable",{"$indexOfArray":["$ristraContable.tra_ind_cre_deb","C"]}]}},"in":{"$cond":{"if":{"$ne":["$$haber",null]},"then":{"$substr":["$$haber",37,3]},"else":null}}}},"ristraContableDebeMoneda":{"$let":{"vars":{"debe":{"$arrayElemAt":["$ristraContable.tra_ristra_contable",{"$indexOfArray":["$ristraContable.tra_ind_cre_deb","D"]}]}},"in":{"$cond":{"if":{"$ne":["$$debe",null]},"then":{"$substr":["$$debe",37,3]},"else":null}}}},"primeraLetraRif":{"$substr":["$tra_rif",0,1]},"ultimaLetraRif":{"$substr":["$tra_rif",8,-1]}}},{"$addFields":{"tra_cuenta_contable":"$cuentaContableHaber","_id.randomKey":{"$toInt":{"$multiply":[{"$rand":{}},100000000]}}}},{"$project":{"_id":1,"cuentaContable":0,"ristraContable":0}},{"$merge":{"into":"sidis_transaccionesOperativas","on":["tra_fecha_contable","tra_cod_op","tra_cuenta_contable","tra_cuenta_contrato","_id"]}}]

















