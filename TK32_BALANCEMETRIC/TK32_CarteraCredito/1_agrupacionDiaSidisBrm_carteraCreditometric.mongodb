[
  {
    $limit: 1,
  },
  {
    $lookup: {
      //we bring the Parametricliquidacion accounts
      from: "Parametricliquidacion",
      pipeline: [
        {
          $project: {
            _id: 0,
          },
        },
      ],
      as: "Parametricliquidacion",
    },
  },
  {
    $project: {
      Parametricliquidacion: 1,
      cuentasContable:
        "$Parametricliquidacion.cuentaContable",
      //add field with today"s date
      todayDate: {
        $subtract: [
          {
            $toDate: {
              $dateFromString: {
                dateString: {
                  $dateToString: {
                    format: "%Y-%m-%dT00:00:00%z",
                    date: {
                      $toDate: "$$NOW",
                    },
                  },
                },
              },
            },
          },
          {
            $multiply: [
              {
                $toInt: "9",
                //"{{$json.offSet}}"
              },
              86400000,
            ],
          },
        ],
      },
    },
  },
  {
    $lookup: {
      //bring today"s docs
      from: "sidis_brm",
      let: {
        todayDate: "$todayDate",
      },
      pipeline: [
        {
          $match: {
            $expr: {
              $eq: [
                "$$todayDate",
                "$fecha_odate",
              ],
            },
          },
        },
        {
          $project: {
            nucta: 1,
            sal_act: {
              $multiply: ["$sal_act", -1],
            },
            sal_ant: {
              $multiply: ["$sal_ant", -1],
            },
            sal_net_act: {
              $multiply: ["$sal_net_act", -1],
            },
          },
        },
      ],
      as: "sidis_brm",
    },
  },
  {
    $addFields: {
      // evaluate today"s data
      avaiableDate: {
        $cond: [
          {
            $gt: [
              {
                $size: "$sidis_brm",
              },
              0,
            ],
          },
          true,
          false,
        ],
      },
      //  add  dates fields
      firstDayMonth: {
        $eq: [
          {
            $dayOfMonth: "$todayDate",
          },
          1,
        ],
      },
      yesterdayDate: {
        $dateAdd: {
          startDate: "$todayDate",
          unit: "day",
          amount: -1,
        },
      },
      previusMonthDate: {
        $dateAdd: {
          startDate: "$todayDate",
          unit: "month",
          amount: -1,
        },
      },
      previusMonthLastDate: {
        $dateAdd: {
          startDate: {
            $dateFromParts: {
              year: {
                $year: "$todayDate",
              },
              month: {
                $month: "$todayDate",
              },
            },
          },
          unit: "day",
          amount: -1,
        },
      },
      previusYearDate: {
        $dateAdd: {
          startDate: "$todayDate",
          unit: "year",
          amount: -1,
        },
      },
      PreviusYearlastDate: {
        $subtract: [
          {
            $dateFromParts: {
              year: {
                $year: "$todayDate",
              },
            },
          },
          86400000,
        ],
      },
      // filter documents corresponding to carta de cr√©dito
      sidis_brm: {
        $filter: {
          input: "$sidis_brm",
          as: "brm",
          cond: {
            $in: [
              "$$brm.nucta",
              "$cuentasContable",
            ],
          },
        },
      },
      cuentasContable: "$$REMOVE",
    },
  },
  {
    $addFields: {
      //add product
      sidis_brm: {
        $map: {
          input: "$sidis_brm",
          as: "brm",
          in: {
            $mergeObjects: [
              "$$brm",
              {
                producto: {
                  $arrayElemAt: [
                    {
                      $filter: {
                        input: {
                          $map: {
                            input:
                              "$Parametricliquidacion",
                            as: "liquidaciones",
                            in: {
                              $cond: [
                                {
                                  $eq: [
                                    "$$liquidaciones.cuentaContable",
                                    "$$brm.nucta",
                                  ],
                                },
                                "$$liquidaciones.productoControlGestion",
                                null,
                              ],
                            },
                          },
                        },
                        as: "filtered",
                        cond: {
                          $ne: [
                            "$$filtered",
                            null,
                          ],
                        },
                      },
                    },
                    0,
                  ],
                },
              },
            ],
          },
        },
      },
    },
  },
  {
    $addFields: {
      _id: "$$REMOVE",
      Parametricliquidacion: "$$REMOVE",
      sidis_brm: "$REMOVE",
      //Calculates total values and by product

      sal_acttotalBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    true,
                    "$$brm.sal_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_anttotalBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    true,
                    "$$brm.sal_ant",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_net_acttotalBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    true,
                    "$$brm.sal_net_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_acttotalBdvBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $in: [
                        "$$brm.producto",
                        [
                          "COMERCIAL",
                          "MICROCREDITO",
                          "PRODUCTIVO",
                          "EMPRENDEBDV",
                          "TDC MC",
                          "TDC VISA",
                          "CREDINOMINA",
                          "CREDITO EN CC",
                        ],
                      ],
                    },
                    "$$brm.sal_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_anttotalBdvBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $in: [
                        "$$brm.producto",
                        [
                          "COMERCIAL",
                          "MICROCREDITO",
                          "PRODUCTIVO",
                          "EMPRENDEBDV",
                          "TDC MC",
                          "TDC VISA",
                          "CREDINOMINA",
                          "CREDITO EN CC",
                        ],
                      ],
                    },
                    "$$brm.sal_ant",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_net_acttotalBdvBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $in: [
                        "$$brm.producto",
                        [
                          "COMERCIAL",
                          "MICROCREDITO",
                          "PRODUCTIVO",
                          "EMPRENDEBDV",
                          "TDC MC",
                          "TDC VISA",
                          "CREDINOMINA",
                          "CREDITO EN CC",
                        ],
                      ],
                    },
                    "$$brm.sal_net_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_actcartTradicionalBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $in: [
                        "$$brm.producto",
                        [
                          "TDC MC",
                          "TDC VISA",
                          "CREDINOMINA",
                          "CREDITO EN CC",
                        ],
                      ],
                    },
                    "$$brm.sal_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_antcartTradicionalBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $in: [
                        "$$brm.producto",
                        [
                          "TDC MC",
                          "TDC VISA",
                          "CREDINOMINA",
                          "CREDITO EN CC",
                        ],
                      ],
                    },
                    "$$brm.sal_ant",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_net_actcartTradicionalBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $in: [
                        "$$brm.producto",
                        [
                          "TDC MC",
                          "TDC VISA",
                          "CREDINOMINA",
                          "CREDITO EN CC",
                        ],
                      ],
                    },
                    "$$brm.sal_net_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_actcomercialUVCBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $eq: [
                        "$$brm.producto",
                        "COMERCIAL",
                      ],
                    },
                    "$$brm.sal_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_antcomercialUVCBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $eq: [
                        "$$brm.producto",
                        "COMERCIAL",
                      ],
                    },
                    "$$brm.sal_ant",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_net_actcomercialUVCBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $eq: [
                        "$$brm.producto",
                        "COMERCIAL",
                      ],
                    },
                    "$$brm.sal_net_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_actmicroCredUVCBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $eq: [
                        "$$brm.producto",
                        "MICROCREDITO",
                      ],
                    },
                    "$$brm.sal_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_antmicroCredUVCBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $eq: [
                        "$$brm.producto",
                        "MICROCREDITO",
                      ],
                    },
                    "$$brm.sal_ant",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_net_actmicroCredUVCBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $eq: [
                        "$$brm.producto",
                        "MICROCREDITO",
                      ],
                    },
                    "$$brm.sal_net_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_actproductivaUVCBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $eq: [
                        "$$brm.producto",
                        "PRODUCTIVO",
                      ],
                    },
                    "$$brm.sal_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_antproductivaUVCBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $eq: [
                        "$$brm.producto",
                        "PRODUCTIVO",
                      ],
                    },
                    "$$brm.sal_ant",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_net_actproductivaUVCBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $eq: [
                        "$$brm.producto",
                        "PRODUCTIVO",
                      ],
                    },
                    "$$brm.sal_net_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_actemprendBdvBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $eq: [
                        "$$brm.producto",
                        "EMPRENDEBDV",
                      ],
                    },
                    "$$brm.sal_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_antemprendBdvBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $eq: [
                        "$$brm.producto",
                        "EMPRENDEBDV",
                      ],
                    },
                    "$$brm.sal_ant",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_net_actemprendBdvBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $eq: [
                        "$$brm.producto",
                        "EMPRENDEBDV",
                      ],
                    },
                    "$$brm.sal_net_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_actotrosBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $not: {
                        $in: [
                          "$$brm.producto",
                          [
                            "COMERCIAL",
                            "MICROCREDITO",
                            "PRODUCTIVO",
                            "EMPRENDEBDV",
                            "TDC MC",
                            "TDC VISA",
                            "CREDINOMINA",
                            "CREDITO EN CC",
                          ],
                        ],
                      },
                    },
                    "$$brm.sal_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_antotrosBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $not: {
                        $in: [
                          "$$brm.producto",
                          [
                            "COMERCIAL",
                            "MICROCREDITO",
                            "PRODUCTIVO",
                            "EMPRENDEBDV",
                            "TDC MC",
                            "TDC VISA",
                            "CREDINOMINA",
                            "CREDITO EN CC",
                          ],
                        ],
                      },
                    },
                    "$$brm.sal_ant",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
      sal_net_actotrosBs: {
        $multiply: [
          {
            $sum: {
              $map: {
                input: "$sidis_brm",
                as: "brm",
                in: {
                  $cond: [
                    {
                      $not: {
                        $in: [
                          "$$brm.producto",
                          [
                            "COMERCIAL",
                            "MICROCREDITO",
                            "PRODUCTIVO",
                            "EMPRENDEBDV",
                            "TDC MC",
                            "TDC VISA",
                            "CREDINOMINA",
                            "CREDITO EN CC",
                          ],
                        ],
                      },
                    },
                    "$$brm.sal_net_act",
                    0,
                  ],
                },
              },
            },
          },
          -1,
        ],
      },
    },
  },
  {
    $lookup: {
      from: "sidis_tasaconversion",
      localField: "todayDate",
      foreignField: "Fecha",
      as: "sidis_tasaconversion",
    },
  },
  {
    $lookup: {
      from: "sidis_tasaconversion",
      localField: "previusMonthLastDate",
      foreignField: "Fecha",
      as: "sidis_tasaconversionpreviusMonthLastDate",
    },
  },
  {
    $addFields: {
      sidis_tasaconversion: "$$REMOVE",
      sidis_tasaconversionpreviusMonthLastDate:
        "$$REMOVE",
      fecha_valor: "$todayDate",
      //convert values from bolivares to dolar
      sal_acttotal: {
        $round: [
          {
            $divide: [
              "$sal_acttotalBs",
              {
                $first:
                  "$sidis_tasaconversion.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_anttotal: {
        $round: [
          {
            $divide: [
              "$sal_anttotalBs",
              {
                $first:
                  "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_net_acttotal: {
        $subtract: [
          {
            $round: [
              {
                $divide: [
                  "$sal_acttotalBs",
                  {
                    $first:
                      "$sidis_tasaconversion.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
          {
            $round: [
              {
                $divide: [
                  "$sal_anttotalBs",
                  {
                    $first:
                      "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
        ],
      },
      sal_acttotalBdv: {
        $round: [
          {
            $divide: [
              "$sal_acttotalBdvBs",
              {
                $first:
                  "$sidis_tasaconversion.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_anttotalBdv: {
        $round: [
          {
            $divide: [
              "$sal_anttotalBdvBs",
              {
                $first:
                  "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_net_acttotalBdv: {
        $subtract: [
          {
            $round: [
              {
                $divide: [
                  "$sal_acttotalBdvBs",
                  {
                    $first:
                      "$sidis_tasaconversion.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
          {
            $round: [
              {
                $divide: [
                  "$sal_anttotalBdvBs",
                  {
                    $first:
                      "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
        ],
      },
      sal_actcartTradicional: {
        $round: [
          {
            $divide: [
              "$sal_actcartTradicionalBs",
              {
                $first:
                  "$sidis_tasaconversion.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_antcartTradicional: {
        $round: [
          {
            $divide: [
              "$sal_antcartTradicionalBs",
              {
                $first:
                  "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_net_actcartTradicional: {
        $subtract: [
          {
            $round: [
              {
                $divide: [
                  "$sal_actcartTradicionalBs",
                  {
                    $first:
                      "$sidis_tasaconversion.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
          {
            $round: [
              {
                $divide: [
                  "$sal_antcartTradicionalBs",
                  {
                    $first:
                      "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
        ],
      },
      sal_actcomercialUVC: {
        $round: [
          {
            $divide: [
              "$sal_actcomercialUVCBs",
              {
                $first:
                  "$sidis_tasaconversion.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_antcomercialUVC: {
        $round: [
          {
            $divide: [
              "$sal_antcomercialUVCBs",
              {
                $first:
                  "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_net_actcomercialUVC: {
        $subtract: [
          {
            $round: [
              {
                $divide: [
                  "$sal_actcomercialUVCBs",
                  {
                    $first:
                      "$sidis_tasaconversion.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
          {
            $round: [
              {
                $divide: [
                  "$sal_antcomercialUVCBs",
                  {
                    $first:
                      "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
        ],
      },
      sal_actmicroCredUVC: {
        $round: [
          {
            $divide: [
              "$sal_actmicroCredUVCBs",
              {
                $first:
                  "$sidis_tasaconversion.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_antmicroCredUVC: {
        $round: [
          {
            $divide: [
              "$sal_antmicroCredUVCBs",
              {
                $first:
                  "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_net_actmicroCredUVC: {
        $subtract: [
          {
            $round: [
              {
                $divide: [
                  "$sal_actmicroCredUVCBs",
                  {
                    $first:
                      "$sidis_tasaconversion.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
          {
            $round: [
              {
                $divide: [
                  "$sal_antmicroCredUVCBs",
                  {
                    $first:
                      "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
        ],
      },
      sal_actproductivaUVC: {
        $round: [
          {
            $divide: [
              "$sal_actproductivaUVCBs",
              {
                $first:
                  "$sidis_tasaconversion.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_antproductivaUVC: {
        $round: [
          {
            $divide: [
              "$sal_antproductivaUVCBs",
              {
                $first:
                  "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_net_actproductivaUVC: {
        $subtract: [
          {
            $round: [
              {
                $divide: [
                  "$sal_actproductivaUVCBs",
                  {
                    $first:
                      "$sidis_tasaconversion.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
          {
            $round: [
              {
                $divide: [
                  "$sal_antproductivaUVCBs",
                  {
                    $first:
                      "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
        ],
      },
      sal_actemprendBdv: {
        $round: [
          {
            $divide: [
              "$sal_actemprendBdvBs",
              {
                $first:
                  "$sidis_tasaconversion.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_antemprendBdv: {
        $round: [
          {
            $divide: [
              "$sal_antemprendBdvBs",
              {
                $first:
                  "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_net_actemprendBdv: {
        $subtract: [
          {
            $round: [
              {
                $divide: [
                  "$sal_actemprendBdvBs",
                  {
                    $first:
                      "$sidis_tasaconversion.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
          {
            $round: [
              {
                $divide: [
                  "$sal_antemprendBdvBs",
                  {
                    $first:
                      "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
        ],
      },
      sal_actotros: {
        $round: [
          {
            $divide: [
              "$sal_actotrosBs",
              {
                $first:
                  "$sidis_tasaconversion.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_antotros: {
        $round: [
          {
            $divide: [
              "$sal_antotrosBs",
              {
                $first:
                  "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
              },
            ],
          },
          4,
        ],
      },
      sal_net_actotros: {
        $subtract: [
          {
            $round: [
              {
                $divide: [
                  "$sal_actotrosBs",
                  {
                    $first:
                      "$sidis_tasaconversion.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
          {
            $round: [
              {
                $divide: [
                  "$sal_antotrosBs",
                  {
                    $first:
                      "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL",
                  },
                ],
              },
              4,
            ],
          },
        ],
      },
    },
  },
  {
    $lookup: {
      from: "CarteraCreditometric",
      localField: "yesterdayDate",
      foreignField: "fecha_valor",
      as: "CarteraCreditometricYesterday",
    },
  },
  {
    $addFields: {
      fecha_valor: "$todayDate",
      todayDate: "$$REMOVE",
      sal_acttotalBs: {
        $cond: [
          "$avaiableDate",
          "$sal_acttotalBs",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_acttotalBs",
          },
        ],
      },
      sal_anttotalBs: {
        $cond: [
          "$avaiableDate",
          "$sal_anttotalBs",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_acttotalBs",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_anttotalBs",
              },
            ],
          },
        ],
      },
      sal_net_acttotalBs: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_acttotalBs",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_acttotalBs",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_anttotalBs",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_acttotalBs",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_anttotalBs",
                  },
                ],
              },
            ],
          },
        ],
      },
      sal_acttotalBdvBs: {
        $cond: [
          "$avaiableDate",
          "$sal_acttotalBdvBs",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_acttotalBdvBs",
          },
        ],
      },
      sal_anttotalBdvBs: {
        $cond: [
          "$avaiableDate",
          "$sal_anttotalBdvBs",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_acttotalBdvBs",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_anttotalBdvBs",
              },
            ],
          },
        ],
      },
      sal_net_acttotalBdvBs: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_acttotalBdvBs",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_acttotalBdvBs",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_anttotalBdvBs",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_acttotalBdvBs",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_anttotalBdvBs",
                  },
                ],
              },
            ],
          },
        ],
      },
      sal_actcartTradicionalBs: {
        $cond: [
          "$avaiableDate",
          "$sal_actcartTradicionalBs",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_actcartTradicionalBs",
          },
        ],
      },
      sal_antcartTradicionalBs: {
        $cond: [
          "$avaiableDate",
          "$sal_antcartTradicionalBs",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actcartTradicionalBs",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_antcartTradicionalBs",
              },
            ],
          },
        ],
      },
      sal_net_actcartTradicionalBs: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_actcartTradicionalBs",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actcartTradicionalBs",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_antcartTradicionalBs",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_actcartTradicionalBs",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_antcartTradicionalBs",
                  },
                ],
              },
            ],
          },
        ],
      },
      sal_actcomercialUVCBs: {
        $cond: [
          "$avaiableDate",
          "$sal_actcomercialUVCBs",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_actcomercialUVCBs",
          },
        ],
      },
      sal_antcomercialUVCBs: {
        $cond: [
          "$avaiableDate",
          "$sal_antcomercialUVCBs",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actcomercialUVCBs",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_antcomercialUVCBs",
              },
            ],
          },
        ],
      },
      sal_net_actcomercialUVCBs: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_actcomercialUVCBs",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actcomercialUVCBs",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_antcomercialUVCBs",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_actcomercialUVCBs",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_antcomercialUVCBs",
                  },
                ],
              },
            ],
          },
        ],
      },
      sal_actmicroCredUVCBs: {
        $cond: [
          "$avaiableDate",
          "$sal_actmicroCredUVCBs",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_actmicroCredUVCBs",
          },
        ],
      },
      sal_antmicroCredUVCBs: {
        $cond: [
          "$avaiableDate",
          "$sal_antmicroCredUVCBs",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actmicroCredUVCBs",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_antmicroCredUVCBs",
              },
            ],
          },
        ],
      },
      sal_net_actmicroCredUVCBs: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_actmicroCredUVCBs",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actmicroCredUVCBs",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_antmicroCredUVCBs",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_actmicroCredUVCBs",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_antmicroCredUVCBs",
                  },
                ],
              },
            ],
          },
        ],
      },
      sal_actproductivaUVCBs: {
        $cond: [
          "$avaiableDate",
          "$sal_actproductivaUVCBs",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_actproductivaUVCBs",
          },
        ],
      },
      sal_antproductivaUVCBs: {
        $cond: [
          "$avaiableDate",
          "$sal_antproductivaUVCBs",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actproductivaUVCBs",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_antproductivaUVCBs",
              },
            ],
          },
        ],
      },
      sal_net_actproductivaUVCBs: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_actproductivaUVCBs",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actproductivaUVCBs",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_antproductivaUVCBs",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_actproductivaUVCBs",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_antproductivaUVCBs",
                  },
                ],
              },
            ],
          },
        ],
      },
      sal_actemprendBdvBs: {
        $cond: [
          "$avaiableDate",
          "$sal_actemprendBdvBs",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_actemprendBdvBs",
          },
        ],
      },
      sal_antemprendBdvBs: {
        $cond: [
          "$avaiableDate",
          "$sal_antemprendBdvBs",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actemprendBdvBs",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_antemprendBdvBs",
              },
            ],
          },
        ],
      },
      sal_net_actemprendBdvBs: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_actemprendBdvBs",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actemprendBdvBs",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_antemprendBdvBs",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_actemprendBdvBs",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_antemprendBdvBs",
                  },
                ],
              },
            ],
          },
        ],
      },
      sal_actotrosBs: {
        $cond: [
          "$avaiableDate",
          "$sal_actotrosBs",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_actotrosBs",
          },
        ],
      },
      sal_antotrosBs: {
        $cond: [
          "$avaiableDate",
          "$sal_antotrosBs",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actotrosBs",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_antotrosBs",
              },
            ],
          },
        ],
      },
      sal_net_actotrosBs: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_actotrosBs",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actotrosBs",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_antotrosBs",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_actotrosBs",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_antotrosBs",
                  },
                ],
              },
            ],
          },
        ],
      },
      sal_acttotal: {
        $cond: [
          "$avaiableDate",
          "$sal_acttotal",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_acttotal",
          },
        ],
      },
      sal_anttotal: {
        $cond: [
          "$avaiableDate",
          "$sal_anttotal",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_acttotal",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_anttotal",
              },
            ],
          },
        ],
      },
      sal_net_acttotal: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_acttotal",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_acttotal",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_anttotal",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_acttotal",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_anttotal",
                  },
                ],
              },
            ],
          },
        ],
      },
      sal_acttotalBdv: {
        $cond: [
          "$avaiableDate",
          "$sal_acttotalBdv",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_acttotalBdv",
          },
        ],
      },
      sal_anttotalBdv: {
        $cond: [
          "$avaiableDate",
          "$sal_anttotalBdv",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_acttotalBdv",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_anttotalBdv",
              },
            ],
          },
        ],
      },
      sal_net_acttotalBdv: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_acttotalBdv",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_acttotalBdv",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_anttotalBdv",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_acttotalBdv",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_anttotalBdv",
                  },
                ],
              },
            ],
          },
        ],
      },
      sal_actcartTradicional: {
        $cond: [
          "$avaiableDate",
          "$sal_actcartTradicional",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_actcartTradicional",
          },
        ],
      },
      sal_antcartTradicional: {
        $cond: [
          "$avaiableDate",
          "$sal_antcartTradicional",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actcartTradicional",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_antcartTradicional",
              },
            ],
          },
        ],
      },
      sal_net_actcartTradicional: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_actcartTradicional",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actcartTradicional",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_antcartTradicional",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_actcartTradicional",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_antcartTradicional",
                  },
                ],
              },
            ],
          },
        ],
      },
      sal_actcomercialUVC: {
        $cond: [
          "$avaiableDate",
          "$sal_actcomercialUVC",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_actcomercialUVC",
          },
        ],
      },
      sal_antcomercialUVC: {
        $cond: [
          "$avaiableDate",
          "$sal_antcomercialUVC",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actcomercialUVC",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_antcomercialUVC",
              },
            ],
          },
        ],
      },
      sal_net_actcomercialUVC: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_actcomercialUVC",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actcomercialUVC",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_antcomercialUVC",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_actcomercialUVC",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_antcomercialUVC",
                  },
                ],
              },
            ],
          },
        ],
      },
      sal_actmicroCredUVC: {
        $cond: [
          "$avaiableDate",
          "$sal_actmicroCredUVC",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_actmicroCredUVC",
          },
        ],
      },
      sal_antmicroCredUVC: {
        $cond: [
          "$avaiableDate",
          "$sal_antmicroCredUVC",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actmicroCredUVC",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_antmicroCredUVC",
              },
            ],
          },
        ],
      },
      sal_net_actmicroCredUVC: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_actmicroCredUVC",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actmicroCredUVC",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_antmicroCredUVC",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_actmicroCredUVC",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_antmicroCredUVC",
                  },
                ],
              },
            ],
          },
        ],
      },
      sal_actproductivaUVC: {
        $cond: [
          "$avaiableDate",
          "$sal_actproductivaUVC",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_actproductivaUVC",
          },
        ],
      },
      sal_antproductivaUVC: {
        $cond: [
          "$avaiableDate",
          "$sal_antproductivaUVC",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actproductivaUVC",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_antproductivaUVC",
              },
            ],
          },
        ],
      },
      sal_net_actproductivaUVC: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_actproductivaUVC",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actproductivaUVC",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_antproductivaUVC",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_actproductivaUVC",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_antproductivaUVC",
                  },
                ],
              },
            ],
          },
        ],
      },
      sal_actemprendBdv: {
        $cond: [
          "$avaiableDate",
          "$sal_actemprendBdv",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_actemprendBdv",
          },
        ],
      },
      sal_antemprendBdv: {
        $cond: [
          "$avaiableDate",
          "$sal_antemprendBdv",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actemprendBdv",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_antemprendBdv",
              },
            ],
          },
        ],
      },
      sal_net_actemprendBdv: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_actemprendBdv",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actemprendBdv",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_antemprendBdv",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_actemprendBdv",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_antemprendBdv",
                  },
                ],
              },
            ],
          },
        ],
      },
      sal_actotros: {
        $cond: [
          "$avaiableDate",
          "$sal_actotros",
          {
            $first:
              "$CarteraCreditometricYesterday.sal_actotros",
          },
        ],
      },
      sal_antotros: {
        $cond: [
          "$avaiableDate",
          "$sal_antotros",
          {
            $cond: [
              "$firstDayMonth",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actotros",
              },
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_antotros",
              },
            ],
          },
        ],
      },
      sal_net_actotros: {
        $subtract: [
          {
            $cond: [
              "$avaiableDate",
              "$sal_actotros",
              {
                $first:
                  "$CarteraCreditometricYesterday.sal_actotros",
              },
            ],
          },
          {
            $cond: [
              "$avaiableDate",
              "$sal_antotros",
              {
                $cond: [
                  "$firstDayMonth",
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_actotros",
                  },
                  {
                    $first:
                      "$CarteraCreditometricYesterday.sal_antotros",
                  },
                ],
              },
            ],
          },
        ],
      },
    },
  },
  {
    $addFields: {
      CarteraCreditometricYesterday: "$$REMOVE",
      adjustmentCond: {
        $switch: {
          branches: [
            {
              case: {
                $and: [
                  {
                    $eq: [
                      {
                        $first:
                          "$CarteraCreditometricYesterday.adjustmentCond",
                      },
                      true,
                    ],
                  },
                  {
                    $in: [
                      {
                        $month: "$fecha_valor",
                      },
                      [7, 8, 9, 10, 11, 12],
                    ],
                  },
                ],
              },
              then: true,
            },
            {
              case: {
                $or: [
                  {
                    $eq: [
                      {
                        $first:
                          "$CarteraCreditometricYesterday.adjustmentCond",
                      },
                      false,
                    ],
                  },
                  {
                    $lte: [
                      {
                        $first:
                          "$CarteraCreditometricYesterday.adjustmentCond",
                      },
                      null,
                    ],
                  },
                ],
              },
              then: {
                $cond: [
                  {
                    $and: [
                      {
                        $lte: [
                          {
                            $ifNull: [
                              {
                                $divide: [
                                  "$sal_acttotalBdvBs",
                                  {
                                    $first:
                                      "$CarteraCreditometricYesterday.sal_acttotalBdvBs",
                                  },
                                ],
                              },
                              1,
                            ],
                          },
                          0.5,
                        ],
                      },
                      {
                        $eq: [
                          {
                            $month:
                              "$fecha_valor",
                          },
                          7,
                        ],
                      },
                    ],
                  },
                  true,
                  false,
                ],
              },
            },
          ],
          default: false,
        },
      },
    },
  },
  {
    $merge: {
      into: "CarteraCreditometric",
      on: "fecha_valor",
      whenMatched: "merge",
      whenNotMatched: "insert",
    },
  },
]


//n8n

[
  {
    "$limit": 1
  }, {
    "$lookup": {
      "from": "Parametricliquidacion", 
      "pipeline": [
        {
          "$project": {
            "_id": 0
          }
        }
      ], 
      "as": "Parametricliquidacion"
    }
  }, {
    "$project": {
      "Parametricliquidacion": 1, 
      "cuentasContable": "$Parametricliquidacion.cuentaContable", 
      "todayDate": {
        "$subtract": [
          {
            "$toDate": {
              "$dateFromString": {
                "dateString": {
                  "$dateToString": {
                    "format": "%Y-%m-%dT00:00:00%z", 
                    "date": {
                      "$toDate": "$$NOW"
                    }
                  }
                }
              }
            }
          }, {
            "$multiply": [
              {
                "$toInt": "{{$json.offSet}}"
              }, 86400000
            ]
          }
        ]
      }
    }
  }, {
    "$lookup": {
      "from": "sidis_brm", 
      "let": {
        "todayDate": "$todayDate"
      }, 
      "pipeline": [
        {
          "$match": {
            "$expr": {
              "$eq": [
                "$$todayDate", "$fecha_odate"
              ]
            }
          }
        }, {
          "$project": {
            "nucta": 1, 
            "sal_act": {
              "$multiply": [
                "$sal_act", -1
              ]
            }, 
            "sal_ant": {
              "$multiply": [
                "$sal_ant", -1
              ]
            }, 
            "sal_net_act": {
              "$multiply": [
                "$sal_net_act", -1
              ]
            }
          }
        }
      ], 
      "as": "sidis_brm"
    }
  }, {
    "$addFields": {
      "avaiableDate": {
        "$cond": [
          {
            "$gt": [
              {
                "$size": "$sidis_brm"
              }, 0
            ]
          }, true, false
        ]
      }, 
      "firstDayMonth": {
        "$eq": [
          {
            "$dayOfMonth": "$todayDate"
          }, 1
        ]
      }, 
      "yesterdayDate": {
        "$dateAdd": {
          "startDate": "$todayDate", 
          "unit": "day", 
          "amount": -1
        }
      }, 
      "previusMonthDate": {
        "$dateAdd": {
          "startDate": "$todayDate", 
          "unit": "month", 
          "amount": -1
        }
      }, 
      "previusMonthLastDate": {
        "$dateAdd": {
          "startDate": {
            "$dateFromParts": {
              "year": {
                "$year": "$todayDate"
              }, 
              "month": {
                "$month": "$todayDate"
              }
            }
          }, 
          "unit": "day", 
          "amount": -1
        }
      }, 
      "previusYearDate": {
        "$dateAdd": {
          "startDate": "$todayDate", 
          "unit": "year", 
          "amount": -1
        }
      }, 
      "PreviusYearlastDate": {
        "$subtract": [
          {
            "$dateFromParts": {
              "year": {
                "$year": "$todayDate"
              }
            }
          }, 86400000
        ]
      }, 
      "sidis_brm": {
        "$filter": {
          "input": "$sidis_brm", 
          "as": "brm", 
          "cond": {
            "$in": [
              "$$brm.nucta", "$cuentasContable"
            ]
          }
        }
      }, 
      "cuentasContable": "$$REMOVE"
    }
  }, {
    "$addFields": {
      "sidis_brm": {
        "$map": {
          "input": "$sidis_brm", 
          "as": "brm", 
          "in": {
            "$mergeObjects": [
              "$$brm", {
                "producto": {
                  "$arrayElemAt": [
                    {
                      "$filter": {
                        "input": {
                          "$map": {
                            "input": "$Parametricliquidacion", 
                            "as": "liquidaciones", 
                            "in": {
                              "$cond": [
                                {
                                  "$eq": [
                                    "$$liquidaciones.cuentaContable", "$$brm.nucta"
                                  ]
                                }, "$$liquidaciones.productoControlGestion", null
                              ]
                            }
                          }
                        }, 
                        "as": "filtered", 
                        "cond": {
                          "$ne": [
                            "$$filtered", null
                          ]
                        }
                      }
                    }, 0
                  ]
                }
              }
            ]
          }
        }
      }
    }
  }, {
    "$addFields": {
      "_id": "$$REMOVE", 
      "Parametricliquidacion": "$$REMOVE", 
      "sidis_brm": "$REMOVE", 
      "sal_acttotalBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    true, "$$brm.sal_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_anttotalBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    true, "$$brm.sal_ant", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_net_acttotalBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    true, "$$brm.sal_net_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_acttotalBdvBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$in": [
                        "$$brm.producto", [
                          "COMERCIAL", "MICROCREDITO", "PRODUCTIVO", "EMPRENDEBDV", "TDC MC", "TDC VISA", "CREDINOMINA", "CREDITO EN CC"
                        ]
                      ]
                    }, "$$brm.sal_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_anttotalBdvBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$in": [
                        "$$brm.producto", [
                          "COMERCIAL", "MICROCREDITO", "PRODUCTIVO", "EMPRENDEBDV", "TDC MC", "TDC VISA", "CREDINOMINA", "CREDITO EN CC"
                        ]
                      ]
                    }, "$$brm.sal_ant", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_net_acttotalBdvBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$in": [
                        "$$brm.producto", [
                          "COMERCIAL", "MICROCREDITO", "PRODUCTIVO", "EMPRENDEBDV", "TDC MC", "TDC VISA", "CREDINOMINA", "CREDITO EN CC"
                        ]
                      ]
                    }, "$$brm.sal_net_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_actcartTradicionalBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$in": [
                        "$$brm.producto", [
                          "TDC MC", "TDC VISA", "CREDINOMINA", "CREDITO EN CC"
                        ]
                      ]
                    }, "$$brm.sal_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_antcartTradicionalBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$in": [
                        "$$brm.producto", [
                          "TDC MC", "TDC VISA", "CREDINOMINA", "CREDITO EN CC"
                        ]
                      ]
                    }, "$$brm.sal_ant", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_net_actcartTradicionalBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$in": [
                        "$$brm.producto", [
                          "TDC MC", "TDC VISA", "CREDINOMINA", "CREDITO EN CC"
                        ]
                      ]
                    }, "$$brm.sal_net_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_actcomercialUVCBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$eq": [
                        "$$brm.producto", "COMERCIAL"
                      ]
                    }, "$$brm.sal_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_antcomercialUVCBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$eq": [
                        "$$brm.producto", "COMERCIAL"
                      ]
                    }, "$$brm.sal_ant", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_net_actcomercialUVCBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$eq": [
                        "$$brm.producto", "COMERCIAL"
                      ]
                    }, "$$brm.sal_net_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_actmicroCredUVCBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$eq": [
                        "$$brm.producto", "MICROCREDITO"
                      ]
                    }, "$$brm.sal_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_antmicroCredUVCBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$eq": [
                        "$$brm.producto", "MICROCREDITO"
                      ]
                    }, "$$brm.sal_ant", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_net_actmicroCredUVCBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$eq": [
                        "$$brm.producto", "MICROCREDITO"
                      ]
                    }, "$$brm.sal_net_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_actproductivaUVCBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$eq": [
                        "$$brm.producto", "PRODUCTIVO"
                      ]
                    }, "$$brm.sal_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_antproductivaUVCBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$eq": [
                        "$$brm.producto", "PRODUCTIVO"
                      ]
                    }, "$$brm.sal_ant", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_net_actproductivaUVCBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$eq": [
                        "$$brm.producto", "PRODUCTIVO"
                      ]
                    }, "$$brm.sal_net_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_actemprendBdvBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$eq": [
                        "$$brm.producto", "EMPRENDEBDV"
                      ]
                    }, "$$brm.sal_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_antemprendBdvBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$eq": [
                        "$$brm.producto", "EMPRENDEBDV"
                      ]
                    }, "$$brm.sal_ant", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_net_actemprendBdvBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$eq": [
                        "$$brm.producto", "EMPRENDEBDV"
                      ]
                    }, "$$brm.sal_net_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_actotrosBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$not": {
                        "$in": [
                          "$$brm.producto", [
                            "COMERCIAL", "MICROCREDITO", "PRODUCTIVO", "EMPRENDEBDV", "TDC MC", "TDC VISA", "CREDINOMINA", "CREDITO EN CC"
                          ]
                        ]
                      }
                    }, "$$brm.sal_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_antotrosBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$not": {
                        "$in": [
                          "$$brm.producto", [
                            "COMERCIAL", "MICROCREDITO", "PRODUCTIVO", "EMPRENDEBDV", "TDC MC", "TDC VISA", "CREDINOMINA", "CREDITO EN CC"
                          ]
                        ]
                      }
                    }, "$$brm.sal_ant", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }, 
      "sal_net_actotrosBs": {
        "$multiply": [
          {
            "$sum": {
              "$map": {
                "input": "$sidis_brm", 
                "as": "brm", 
                "in": {
                  "$cond": [
                    {
                      "$not": {
                        "$in": [
                          "$$brm.producto", [
                            "COMERCIAL", "MICROCREDITO", "PRODUCTIVO", "EMPRENDEBDV", "TDC MC", "TDC VISA", "CREDINOMINA", "CREDITO EN CC"
                          ]
                        ]
                      }
                    }, "$$brm.sal_net_act", 0
                  ]
                }
              }
            }
          }, -1
        ]
      }
    }
  }, {
    "$lookup": {
      "from": "sidis_tasaconversion", 
      "localField": "todayDate", 
      "foreignField": "Fecha", 
      "as": "sidis_tasaconversion"
    }
  }, {
    "$lookup": {
      "from": "sidis_tasaconversion", 
      "localField": "previusMonthLastDate", 
      "foreignField": "Fecha", 
      "as": "sidis_tasaconversionpreviusMonthLastDate"
    }
  }, {
    "$addFields": {
      "sidis_tasaconversion": "$$REMOVE", 
      "sidis_tasaconversionpreviusMonthLastDate": "$$REMOVE", 
      "fecha_valor": "$todayDate", 
      "sal_acttotal": {
        "$round": [
          {
            "$divide": [
              "$sal_acttotalBs", {
                "$first": "$sidis_tasaconversion.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_anttotal": {
        "$round": [
          {
            "$divide": [
              "$sal_anttotalBs", {
                "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_net_acttotal": {
        "$subtract": [
          {
            "$round": [
              {
                "$divide": [
                  "$sal_acttotalBs", {
                    "$first": "$sidis_tasaconversion.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }, {
            "$round": [
              {
                "$divide": [
                  "$sal_anttotalBs", {
                    "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }
        ]
      }, 
      "sal_acttotalBdv": {
        "$round": [
          {
            "$divide": [
              "$sal_acttotalBdvBs", {
                "$first": "$sidis_tasaconversion.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_anttotalBdv": {
        "$round": [
          {
            "$divide": [
              "$sal_anttotalBdvBs", {
                "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_net_acttotalBdv": {
        "$subtract": [
          {
            "$round": [
              {
                "$divide": [
                  "$sal_acttotalBdvBs", {
                    "$first": "$sidis_tasaconversion.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }, {
            "$round": [
              {
                "$divide": [
                  "$sal_anttotalBdvBs", {
                    "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }
        ]
      }, 
      "sal_actcartTradicional": {
        "$round": [
          {
            "$divide": [
              "$sal_actcartTradicionalBs", {
                "$first": "$sidis_tasaconversion.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_antcartTradicional": {
        "$round": [
          {
            "$divide": [
              "$sal_antcartTradicionalBs", {
                "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_net_actcartTradicional": {
        "$subtract": [
          {
            "$round": [
              {
                "$divide": [
                  "$sal_actcartTradicionalBs", {
                    "$first": "$sidis_tasaconversion.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }, {
            "$round": [
              {
                "$divide": [
                  "$sal_antcartTradicionalBs", {
                    "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }
        ]
      }, 
      "sal_actcomercialUVC": {
        "$round": [
          {
            "$divide": [
              "$sal_actcomercialUVCBs", {
                "$first": "$sidis_tasaconversion.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_antcomercialUVC": {
        "$round": [
          {
            "$divide": [
              "$sal_antcomercialUVCBs", {
                "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_net_actcomercialUVC": {
        "$subtract": [
          {
            "$round": [
              {
                "$divide": [
                  "$sal_actcomercialUVCBs", {
                    "$first": "$sidis_tasaconversion.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }, {
            "$round": [
              {
                "$divide": [
                  "$sal_antcomercialUVCBs", {
                    "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }
        ]
      }, 
      "sal_actmicroCredUVC": {
        "$round": [
          {
            "$divide": [
              "$sal_actmicroCredUVCBs", {
                "$first": "$sidis_tasaconversion.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_antmicroCredUVC": {
        "$round": [
          {
            "$divide": [
              "$sal_antmicroCredUVCBs", {
                "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_net_actmicroCredUVC": {
        "$subtract": [
          {
            "$round": [
              {
                "$divide": [
                  "$sal_actmicroCredUVCBs", {
                    "$first": "$sidis_tasaconversion.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }, {
            "$round": [
              {
                "$divide": [
                  "$sal_antmicroCredUVCBs", {
                    "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }
        ]
      }, 
      "sal_actproductivaUVC": {
        "$round": [
          {
            "$divide": [
              "$sal_actproductivaUVCBs", {
                "$first": "$sidis_tasaconversion.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_antproductivaUVC": {
        "$round": [
          {
            "$divide": [
              "$sal_antproductivaUVCBs", {
                "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_net_actproductivaUVC": {
        "$subtract": [
          {
            "$round": [
              {
                "$divide": [
                  "$sal_actproductivaUVCBs", {
                    "$first": "$sidis_tasaconversion.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }, {
            "$round": [
              {
                "$divide": [
                  "$sal_antproductivaUVCBs", {
                    "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }
        ]
      }, 
      "sal_actemprendBdv": {
        "$round": [
          {
            "$divide": [
              "$sal_actemprendBdvBs", {
                "$first": "$sidis_tasaconversion.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_antemprendBdv": {
        "$round": [
          {
            "$divide": [
              "$sal_antemprendBdvBs", {
                "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_net_actemprendBdv": {
        "$subtract": [
          {
            "$round": [
              {
                "$divide": [
                  "$sal_actemprendBdvBs", {
                    "$first": "$sidis_tasaconversion.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }, {
            "$round": [
              {
                "$divide": [
                  "$sal_antemprendBdvBs", {
                    "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }
        ]
      }, 
      "sal_actotros": {
        "$round": [
          {
            "$divide": [
              "$sal_actotrosBs", {
                "$first": "$sidis_tasaconversion.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_antotros": {
        "$round": [
          {
            "$divide": [
              "$sal_antotrosBs", {
                "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
              }
            ]
          }, 4
        ]
      }, 
      "sal_net_actotros": {
        "$subtract": [
          {
            "$round": [
              {
                "$divide": [
                  "$sal_actotrosBs", {
                    "$first": "$sidis_tasaconversion.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }, {
            "$round": [
              {
                "$divide": [
                  "$sal_antotrosBs", {
                    "$first": "$sidis_tasaconversionpreviusMonthLastDate.Tasa_DOL"
                  }
                ]
              }, 4
            ]
          }
        ]
      }
    }
  }, {
    "$lookup": {
      "from": "CarteraCreditometric", 
      "localField": "yesterdayDate", 
      "foreignField": "fecha_valor", 
      "as": "CarteraCreditometricYesterday"
    }
  }, {
    "$addFields": {
      "fecha_valor": "$todayDate", 
      "todayDate": "$$REMOVE", 
      "sal_acttotalBs": {
        "$cond": [
          "$avaiableDate", "$sal_acttotalBs", {
            "$first": "$CarteraCreditometricYesterday.sal_acttotalBs"
          }
        ]
      }, 
      "sal_anttotalBs": {
        "$cond": [
          "$avaiableDate", "$sal_anttotalBs", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_acttotalBs"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_anttotalBs"
              }
            ]
          }
        ]
      }, 
      "sal_net_acttotalBs": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_acttotalBs", {
                "$first": "$CarteraCreditometricYesterday.sal_acttotalBs"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_anttotalBs", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_acttotalBs"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_anttotalBs"
                  }
                ]
              }
            ]
          }
        ]
      }, 
      "sal_acttotalBdvBs": {
        "$cond": [
          "$avaiableDate", "$sal_acttotalBdvBs", {
            "$first": "$CarteraCreditometricYesterday.sal_acttotalBdvBs"
          }
        ]
      }, 
      "sal_anttotalBdvBs": {
        "$cond": [
          "$avaiableDate", "$sal_anttotalBdvBs", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_acttotalBdvBs"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_anttotalBdvBs"
              }
            ]
          }
        ]
      }, 
      "sal_net_acttotalBdvBs": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_acttotalBdvBs", {
                "$first": "$CarteraCreditometricYesterday.sal_acttotalBdvBs"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_anttotalBdvBs", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_acttotalBdvBs"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_anttotalBdvBs"
                  }
                ]
              }
            ]
          }
        ]
      }, 
      "sal_actcartTradicionalBs": {
        "$cond": [
          "$avaiableDate", "$sal_actcartTradicionalBs", {
            "$first": "$CarteraCreditometricYesterday.sal_actcartTradicionalBs"
          }
        ]
      }, 
      "sal_antcartTradicionalBs": {
        "$cond": [
          "$avaiableDate", "$sal_antcartTradicionalBs", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_actcartTradicionalBs"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_antcartTradicionalBs"
              }
            ]
          }
        ]
      }, 
      "sal_net_actcartTradicionalBs": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_actcartTradicionalBs", {
                "$first": "$CarteraCreditometricYesterday.sal_actcartTradicionalBs"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_antcartTradicionalBs", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_actcartTradicionalBs"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_antcartTradicionalBs"
                  }
                ]
              }
            ]
          }
        ]
      }, 
      "sal_actcomercialUVCBs": {
        "$cond": [
          "$avaiableDate", "$sal_actcomercialUVCBs", {
            "$first": "$CarteraCreditometricYesterday.sal_actcomercialUVCBs"
          }
        ]
      }, 
      "sal_antcomercialUVCBs": {
        "$cond": [
          "$avaiableDate", "$sal_antcomercialUVCBs", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_actcomercialUVCBs"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_antcomercialUVCBs"
              }
            ]
          }
        ]
      }, 
      "sal_net_actcomercialUVCBs": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_actcomercialUVCBs", {
                "$first": "$CarteraCreditometricYesterday.sal_actcomercialUVCBs"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_antcomercialUVCBs", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_actcomercialUVCBs"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_antcomercialUVCBs"
                  }
                ]
              }
            ]
          }
        ]
      }, 
      "sal_actmicroCredUVCBs": {
        "$cond": [
          "$avaiableDate", "$sal_actmicroCredUVCBs", {
            "$first": "$CarteraCreditometricYesterday.sal_actmicroCredUVCBs"
          }
        ]
      }, 
      "sal_antmicroCredUVCBs": {
        "$cond": [
          "$avaiableDate", "$sal_antmicroCredUVCBs", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_actmicroCredUVCBs"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_antmicroCredUVCBs"
              }
            ]
          }
        ]
      }, 
      "sal_net_actmicroCredUVCBs": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_actmicroCredUVCBs", {
                "$first": "$CarteraCreditometricYesterday.sal_actmicroCredUVCBs"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_antmicroCredUVCBs", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_actmicroCredUVCBs"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_antmicroCredUVCBs"
                  }
                ]
              }
            ]
          }
        ]
      }, 
      "sal_actproductivaUVCBs": {
        "$cond": [
          "$avaiableDate", "$sal_actproductivaUVCBs", {
            "$first": "$CarteraCreditometricYesterday.sal_actproductivaUVCBs"
          }
        ]
      }, 
      "sal_antproductivaUVCBs": {
        "$cond": [
          "$avaiableDate", "$sal_antproductivaUVCBs", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_actproductivaUVCBs"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_antproductivaUVCBs"
              }
            ]
          }
        ]
      }, 
      "sal_net_actproductivaUVCBs": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_actproductivaUVCBs", {
                "$first": "$CarteraCreditometricYesterday.sal_actproductivaUVCBs"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_antproductivaUVCBs", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_actproductivaUVCBs"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_antproductivaUVCBs"
                  }
                ]
              }
            ]
          }
        ]
      }, 
      "sal_actemprendBdvBs": {
        "$cond": [
          "$avaiableDate", "$sal_actemprendBdvBs", {
            "$first": "$CarteraCreditometricYesterday.sal_actemprendBdvBs"
          }
        ]
      }, 
      "sal_antemprendBdvBs": {
        "$cond": [
          "$avaiableDate", "$sal_antemprendBdvBs", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_actemprendBdvBs"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_antemprendBdvBs"
              }
            ]
          }
        ]
      }, 
      "sal_net_actemprendBdvBs": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_actemprendBdvBs", {
                "$first": "$CarteraCreditometricYesterday.sal_actemprendBdvBs"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_antemprendBdvBs", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_actemprendBdvBs"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_antemprendBdvBs"
                  }
                ]
              }
            ]
          }
        ]
      }, 
      "sal_actotrosBs": {
        "$cond": [
          "$avaiableDate", "$sal_actotrosBs", {
            "$first": "$CarteraCreditometricYesterday.sal_actotrosBs"
          }
        ]
      }, 
      "sal_antotrosBs": {
        "$cond": [
          "$avaiableDate", "$sal_antotrosBs", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_actotrosBs"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_antotrosBs"
              }
            ]
          }
        ]
      }, 
      "sal_net_actotrosBs": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_actotrosBs", {
                "$first": "$CarteraCreditometricYesterday.sal_actotrosBs"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_antotrosBs", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_actotrosBs"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_antotrosBs"
                  }
                ]
              }
            ]
          }
        ]
      }, 
      "sal_acttotal": {
        "$cond": [
          "$avaiableDate", "$sal_acttotal", {
            "$first": "$CarteraCreditometricYesterday.sal_acttotal"
          }
        ]
      }, 
      "sal_anttotal": {
        "$cond": [
          "$avaiableDate", "$sal_anttotal", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_acttotal"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_anttotal"
              }
            ]
          }
        ]
      }, 
      "sal_net_acttotal": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_acttotal", {
                "$first": "$CarteraCreditometricYesterday.sal_acttotal"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_anttotal", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_acttotal"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_anttotal"
                  }
                ]
              }
            ]
          }
        ]
      }, 
      "sal_acttotalBdv": {
        "$cond": [
          "$avaiableDate", "$sal_acttotalBdv", {
            "$first": "$CarteraCreditometricYesterday.sal_acttotalBdv"
          }
        ]
      }, 
      "sal_anttotalBdv": {
        "$cond": [
          "$avaiableDate", "$sal_anttotalBdv", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_acttotalBdv"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_anttotalBdv"
              }
            ]
          }
        ]
      }, 
      "sal_net_acttotalBdv": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_acttotalBdv", {
                "$first": "$CarteraCreditometricYesterday.sal_acttotalBdv"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_anttotalBdv", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_acttotalBdv"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_anttotalBdv"
                  }
                ]
              }
            ]
          }
        ]
      }, 
      "sal_actcartTradicional": {
        "$cond": [
          "$avaiableDate", "$sal_actcartTradicional", {
            "$first": "$CarteraCreditometricYesterday.sal_actcartTradicional"
          }
        ]
      }, 
      "sal_antcartTradicional": {
        "$cond": [
          "$avaiableDate", "$sal_antcartTradicional", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_actcartTradicional"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_antcartTradicional"
              }
            ]
          }
        ]
      }, 
      "sal_net_actcartTradicional": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_actcartTradicional", {
                "$first": "$CarteraCreditometricYesterday.sal_actcartTradicional"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_antcartTradicional", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_actcartTradicional"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_antcartTradicional"
                  }
                ]
              }
            ]
          }
        ]
      }, 
      "sal_actcomercialUVC": {
        "$cond": [
          "$avaiableDate", "$sal_actcomercialUVC", {
            "$first": "$CarteraCreditometricYesterday.sal_actcomercialUVC"
          }
        ]
      }, 
      "sal_antcomercialUVC": {
        "$cond": [
          "$avaiableDate", "$sal_antcomercialUVC", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_actcomercialUVC"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_antcomercialUVC"
              }
            ]
          }
        ]
      }, 
      "sal_net_actcomercialUVC": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_actcomercialUVC", {
                "$first": "$CarteraCreditometricYesterday.sal_actcomercialUVC"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_antcomercialUVC", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_actcomercialUVC"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_antcomercialUVC"
                  }
                ]
              }
            ]
          }
        ]
      }, 
      "sal_actmicroCredUVC": {
        "$cond": [
          "$avaiableDate", "$sal_actmicroCredUVC", {
            "$first": "$CarteraCreditometricYesterday.sal_actmicroCredUVC"
          }
        ]
      }, 
      "sal_antmicroCredUVC": {
        "$cond": [
          "$avaiableDate", "$sal_antmicroCredUVC", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_actmicroCredUVC"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_antmicroCredUVC"
              }
            ]
          }
        ]
      }, 
      "sal_net_actmicroCredUVC": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_actmicroCredUVC", {
                "$first": "$CarteraCreditometricYesterday.sal_actmicroCredUVC"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_antmicroCredUVC", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_actmicroCredUVC"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_antmicroCredUVC"
                  }
                ]
              }
            ]
          }
        ]
      }, 
      "sal_actproductivaUVC": {
        "$cond": [
          "$avaiableDate", "$sal_actproductivaUVC", {
            "$first": "$CarteraCreditometricYesterday.sal_actproductivaUVC"
          }
        ]
      }, 
      "sal_antproductivaUVC": {
        "$cond": [
          "$avaiableDate", "$sal_antproductivaUVC", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_actproductivaUVC"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_antproductivaUVC"
              }
            ]
          }
        ]
      }, 
      "sal_net_actproductivaUVC": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_actproductivaUVC", {
                "$first": "$CarteraCreditometricYesterday.sal_actproductivaUVC"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_antproductivaUVC", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_actproductivaUVC"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_antproductivaUVC"
                  }
                ]
              }
            ]
          }
        ]
      }, 
      "sal_actemprendBdv": {
        "$cond": [
          "$avaiableDate", "$sal_actemprendBdv", {
            "$first": "$CarteraCreditometricYesterday.sal_actemprendBdv"
          }
        ]
      }, 
      "sal_antemprendBdv": {
        "$cond": [
          "$avaiableDate", "$sal_antemprendBdv", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_actemprendBdv"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_antemprendBdv"
              }
            ]
          }
        ]
      }, 
      "sal_net_actemprendBdv": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_actemprendBdv", {
                "$first": "$CarteraCreditometricYesterday.sal_actemprendBdv"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_antemprendBdv", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_actemprendBdv"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_antemprendBdv"
                  }
                ]
              }
            ]
          }
        ]
      }, 
      "sal_actotros": {
        "$cond": [
          "$avaiableDate", "$sal_actotros", {
            "$first": "$CarteraCreditometricYesterday.sal_actotros"
          }
        ]
      }, 
      "sal_antotros": {
        "$cond": [
          "$avaiableDate", "$sal_antotros", {
            "$cond": [
              "$firstDayMonth", {
                "$first": "$CarteraCreditometricYesterday.sal_actotros"
              }, {
                "$first": "$CarteraCreditometricYesterday.sal_antotros"
              }
            ]
          }
        ]
      }, 
      "sal_net_actotros": {
        "$subtract": [
          {
            "$cond": [
              "$avaiableDate", "$sal_actotros", {
                "$first": "$CarteraCreditometricYesterday.sal_actotros"
              }
            ]
          }, {
            "$cond": [
              "$avaiableDate", "$sal_antotros", {
                "$cond": [
                  "$firstDayMonth", {
                    "$first": "$CarteraCreditometricYesterday.sal_actotros"
                  }, {
                    "$first": "$CarteraCreditometricYesterday.sal_antotros"
                  }
                ]
              }
            ]
          }
        ]
      }
    }
  }, {
    "$addFields": {
      "CarteraCreditometricYesterday": "$$REMOVE", 
      "adjustmentCond": {
        "$switch": {
          "branches": [
            {
              "case": {
                "$and": [
                  {
                    "$eq": [
                      {
                        "$first": "$CarteraCreditometricYesterday.adjustmentCond"
                      }, true
                    ]
                  }, {
                    "$in": [
                      {
                        "$month": "$fecha_valor"
                      }, [
                        7, 8, 9, 10, 11, 12
                      ]
                    ]
                  }
                ]
              }, 
              "then": true
            }, {
              "case": {
                "$or": [
                  {
                    "$eq": [
                      {
                        "$first": "$CarteraCreditometricYesterday.adjustmentCond"
                      }, false
                    ]
                  }, {
                    "$lte": [
                      {
                        "$first": "$CarteraCreditometricYesterday.adjustmentCond"
                      }, null
                    ]
                  }
                ]
              }, 
              "then": {
                "$cond": [
                  {
                    "$and": [
                      {
                        "$lte": [
                          {
                            "$ifNull": [
                              {
                                "$divide": [
                                  "$sal_acttotalBdvBs", {
                                    "$first": "$CarteraCreditometricYesterday.sal_acttotalBdvBs"
                                  }
                                ]
                              }, 1
                            ]
                          }, 0.5
                        ]
                      }, {
                        "$eq": [
                          {
                            "$month": "$fecha_valor"
                          }, 7
                        ]
                      }
                    ]
                  }, true, false
                ]
              }
            }
          ], 
          "default": false
        }
      }
    }
  }, {
    "$merge": {
      "into": "CarteraCreditometric", 
      "on": "fecha_valor", 
      "whenMatched": "merge", 
      "whenNotMatched": "insert"
    }
  }
]