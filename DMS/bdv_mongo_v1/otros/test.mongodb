db.ren_transaccion_new.aggregate([
  {
    $lookup: {
      f_"ren_margen_cliente_diario",
      let: { tra_contrato: "$Tra_Cuenta_Contrato" },
      pipeline: [
        {
          $match: {
            $and: [
              { "Mcl_Estatus": "A" },
              { "mcl_naturaleza_producto": { $in: [2] } },
              { "mcl_producto": { $in: [1404, 1410, 1414, 1416] } },
              { "Mcl_Fecha_Proceso": { $eq: new Date(new Date().setDate(new Date().getDate()-1)) } },
              // campo por donde une, Mcl_contraro es el campo externo
              { $expr: { $eq: ["$$tra_contrato", "$Mcl_Contrato"] } }
            ]
          }
        },
        {
          $project: {
            _id: 0,
            tra_rif: "$mcl_rif_cedula",
            tra_banca: "$mcl_banca",
            tra_segmento: "$mcl_segmento",
            tra_subsegmento: "$mcl_subsegmento",
            tra_nivel_socioecon: "$mcl_nivel_socioecon",
            tra_contrato: "$mcl_contrato",
            tra_producto: "$mcl_producto"
          }
        }
      ],
      as: "a"
    }
  },
  {
    $unwind: "$a"
  },
  {
    $match: {
      $and: [
        { "Tra_Fecha_Operacion": { $eq: new Date(new Date().setDate(new Date().getDate()-1)) } },
        { "tra_ind_cre_deb": "C" },
        { "tra_ristra_contable": { $regex: /^(?:(?!VES).)*$/ } },
        { "tra_cod_op": { $in: [8230, 6624, 6761, 6068] } }
      ]
    }
  },
  {
    $project: {
      _id: 0,
      Tra_Fecha_Operacion: 1,
      tra_entidad: 1,
      tra_oficina_operante: 1,
      tra_oficina_origen: 1,
      tra_oficina_destino: 1,
      tra_desc_oficina: 1,
      tra_canal: 1,
      tra_usuario: 1,
      tra_fecha_hora: 1,
      tra_cuenta_contrato: 1,
      tra_monto_haber: 1,
      tra_cod_op: 1,
      tra_desc_cod_op: 1,
      Tra_Serial_De_Operacion: 1,
      tra_rif: "$a.tra_rif",
      tra_producto: "$a.tra_producto",
      tra_banca: "$a.tra_banca",
      tra_segmento: "$a.tra_segmento",
     
