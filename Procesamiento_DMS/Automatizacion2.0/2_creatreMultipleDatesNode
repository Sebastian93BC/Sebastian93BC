[
  {
    "$match": {
      "processName": "{{$json.processName}}"
    }
  }, {
    "$set": {
      "_id": "$$REMOVE", 
      "processDate": {
        "$toDate": "{{$json.processDate}}"
      }, 
      "startDate": "$$NOW", 
      "status": "En Proceso"
    }
  }, {
    "$addFields": {
      "nextMonthFirstDate": {
        "$dateAdd": {
          "startDate": {
            "$dateFromParts": {
              "year": {
                "$year": "$processDate"
              }, 
              "month": {
                "$month": "$processDate"
              }
            }
          }, 
          "unit": "month", 
          "amount": 1
        }
      }
    }
  }, {
    "$unwind": {
      "path": "$subProcess"
    }
  }, {
    "$unwind": {
      "path": "$subProcess.parallelizationIndex", 
      "preserveNullAndEmptyArrays": true
    }
  }, {
    "$addFields": {
      "subProcess.parallelizationIndex": {
        "$dateSubtract": {
          "startDate": {
            "$dateSubtract": {
              "startDate": "$nextMonthFirstDate", 
              "unit": "month", 
              "amount": {
                "$toInt": "$subProcess.parallelizationIndex"
              }
            }
          }, 
          "unit": "day", 
          "amount": 1
        }
      }, 
      "nextMonthFirstDate": "$$REMOVE"
    }
  }, {
    "$sort": {
      "subProcess.parallelizationIndex": 1
    }
  }, {
    "$match": {
      "subProcess.activeProcess": true
    }
  }, {
    "$addFields": {
      "subProcess.parallelizationIndex": {
        "$substr": [
          {
            "$toString": "$subProcess.parallelizationIndex"
          }, 0, 10
        ]
      }
    }
  }, {
    "$set": {
      "subProcess.subProcessName": {
        "$cond": [
          {
            "$ifNull": [
              "$subProcess.parallelizationIndex", false
            ]
          }, {
            "$concat": [
              "$subProcess.subProcessName", "_", "$subProcess.parallelizationIndex"
            ]
          }, "$subProcess.subProcessName"
        ]
      }, 
      "subProcess.subProcessDate": {
        "$toDate": "$subProcess.parallelizationIndex"
      }, 
      "subProcess.status": "En Espera"
    }
  }, {
    "$addFields": {
      "subProcessName": "$subProcess.subProcessName", 
      "subProcessDate": "$subProcess.subProcessDate"
    }
  }, {
    "$merge": {
      "into": "sidis_statusProcess", 
      "on": [
        "processName", "processDate", "subProcessName", "subProcessDate"
      ], 
      "whenMatched": "replace"
    }
  }
]