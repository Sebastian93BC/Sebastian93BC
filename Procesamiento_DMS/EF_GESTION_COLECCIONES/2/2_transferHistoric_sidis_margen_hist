[\r\n  {\r\n    \"$match\": {\r\n      \"$and\": [\r\n        {\r\n          \"$expr\": {\r\n            \"$lte\": [\r\n              \"$mcl_fecha_proceso\", {\r\n                \"$dateSubtract\": {\r\n                  \"startDate\": {\r\n                    \"$dateSubtract\": {\r\n                      \"startDate\": {\r\n                        \"$dateAdd\": {\r\n                          \"startDate\": {\r\n                            \"$dateTrunc\": {\r\n                              \"date\": {\r\n                                \"$toDate\": \"@processDate\"\r\n                              }, \r\n                              \"unit\": \"month\"\r\n                            }\r\n                          }, \r\n                          \"unit\": \"month\", \r\n                          \"amount\": 1\r\n                        }\r\n                      }, \r\n                      \"unit\": \"month\", \r\n                      \"amount\": {\r\n                        \"$toInt\": \"@timingInMonth\"\r\n                      }\r\n                    }\r\n                  }, \r\n                  \"unit\": \"day\", \r\n                  \"amount\": 1\r\n                }\r\n              }\r\n            ]\r\n          }\r\n        }, {\r\n          \"$expr\": {\r\n            \"$eq\": [\r\n              \"$lastDigRif\", {\r\n                \"$toString\": \"@lastDigRif\"\r\n              }\r\n            ]\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }, {\r\n    \"$merge\": {\r\n      \"into\": \"sidis_margen_hist\", \r\n      \"on\": [\r\n        \"mcl_rif_cedula\", \"lastDigRif\", \"mcl_fecha_proceso\", \"_id\"\r\n      ], \r\n      \"whenNotMatched\": \"insert\"\r\n    }\r\n  }\r\n]