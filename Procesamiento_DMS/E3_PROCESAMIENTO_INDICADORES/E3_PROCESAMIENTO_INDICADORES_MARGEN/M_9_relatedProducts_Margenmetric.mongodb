[
  {
    $match: {
      $expr: {
        $eq: [
          "$mcl_fecha_proceso",
          {
            $toDate: "2023-11-30",
            //"{{$json.fechaProceso}}"
          },
        ],
      },

      mcl_banca: {
        $nin: ["0", "4", "5", 0, 4, 5],
      },
      "sidisProducto.prd_codigo_producto": {
        $in: [
          1117, 1140, 1106, 1136, 1406, 200, 1111,
          1197, 1404, 100, 819, 805, 1133, 113,
          198, 1414, 1405, 1408, 1122, 108, 9502,
          9501, 101, 1407, 9506, 1190, 1114, 1330,
          1170, 197, 210, 1310, 1112, 1410, 106,
          1160, 1401, 1121, 1360, 381, 1350, 280,
          1316, 2701, 1390, 2601, 329, 1320, 107,
          208, 1380, 1152, 1134, 5329, 2501, 325,
          316, 1315, 851, 1340, 1123, 120, 313,
          1264, 203, 1341, 861, 2401, 211, 2402,
          852, 809, 196, 202, 324, 1131, 206, 853,
          311, 860, 808, 201, 1416, 858, 205, 530,
          2608, 364, 2502, 1105, 9509, 315, 730,
          308, 1104, 1113, 1268, 2603, 2702, 2703,
          301, 333, 906, 1115, 1150, 1262, 1415,
          2503, 2607, 2704, 2705, 102, 103, 104,
          105, 109, 110, 111, 112, 199, 204, 207,
          209, 215, 300, 302, 303, 304, 305, 306,
          307, 309, 310, 312, 314, 317, 318, 319,
          320, 321, 322, 323, 326, 327, 328, 330,
          331, 332, 334, 335, 336, 337, 338, 339,
          340, 341, 342, 343, 344, 345, 346, 347,
          348, 349, 350, 351, 352, 353, 354, 355,
          356, 357, 358, 359, 360, 361, 362, 363,
          365, 366, 367, 368, 369, 370, 371, 372,
          373, 374, 375, 376, 377, 378, 379, 380,
          383, 386, 388, 393, 394, 395, 396, 397,
          398, 399, 401, 402, 404, 410, 412, 414,
          416, 511, 512, 520, 521, 522, 526, 527,
          529, 532, 534, 535, 550, 556, 558, 559,
          561, 563, 570, 571, 572, 595, 600, 601,
          602, 603, 604, 605, 607, 608, 609, 610,
          611, 612, 699, 700, 701, 703, 731, 800,
          801, 802, 803, 804, 806, 807, 810, 811,
          812, 813, 814, 815, 816, 817, 818, 820,
          821, 822, 823, 824, 825, 826, 827, 854,
          855, 856, 857, 859, 887, 899, 902, 904,
          905, 907, 908, 909, 910, 911, 912, 1101,
          1103, 1107, 1108, 1109, 1110, 1116,
          1118, 1119, 1120, 1124, 1125, 1126,
          1127, 1128, 1129, 1130, 1132, 1135,
          1141, 1142, 1180, 1191, 1192, 1199,
          1261, 1263, 1265, 1266, 1267, 1269,
          1270, 1271, 1272, 1273, 1274, 1275,
          1277, 1278, 1279, 1280, 1301, 1307,
          1317, 1322, 1323, 1324, 1400, 1402,
          1403, 1501, 1502, 1503, 1506, 1507,
          1508, 2064, 2070, 2071, 2100, 2101,
          2102, 2200, 2201, 2202, 2300, 2301,
          2302, 2324, 2403, 2504, 2606, 2609,
          3300, 3301, 3302, 3384, 3385, 3394,
          3395, 3404, 3405, 4301, 4302, 4304,
          4305, 4308, 4309, 4311, 4312, 4313,
          4314, 4315, 4316, 4320, 4321, 4323,
          4324, 4325, 4328, 4329, 4333, 4334,
          4364, 4383, 8887, 8888, 8890, 8891,
          9503, 9504, 9507, 9508, 9510, 9998,
        ],
      },
    },
  },
  {
    $project: {
      rifCedula: "$mcl_rif_cedula",
      fechaProceso: "$mcl_fecha_proceso",
      productName:
        "$sidisProducto.prd_nombre_producto",
      productCode:
        "$sidisProducto.prd_codigo_producto",
      _id: 0,
    },
  },
  {
    $group: {
      _id: {
        rifCedula: "$rifCedula",
        fechaProceso: "$fechaProceso",
      },
      relatedProducts: {
        $addToSet: {
          name: "$productName",
          lastUse: "$fechaProceso",
          code: "$productCode",
          active: {
            $cond: [
              {
                $in: [
                  "$productCode",
                  [
                    1117, 1140, 1106, 1136, 1406,
                    200, 1111, 1197, 1404, 100,
                    819, 805, 1133, 113, 198,
                    1414, 1405, 1408, 1122, 108,
                    9502, 9501, 101, 1407, 9506,
                    1190, 1114, 1330, 1170, 197,
                    210, 1310, 1112, 1410, 106,
                    1160, 1401, 1121, 1360, 381,
                    1350, 280, 1316, 2701, 1390,
                    2601, 329, 1320, 107, 208,
                    1380, 1152, 1134, 5329, 2501,
                    325, 316, 1315, 851, 1340,
                    1123, 120, 313, 1264, 203,
                    1341, 861, 2401, 211, 2402,
                    852, 809, 196, 202, 324, 1131,
                    206, 853, 311, 860, 808, 201,
                    1416, 858, 205, 530, 2608,
                    364, 2502, 1105, 9509, 315,
                    730, 308, 1104, 1113, 1268,
                    2603, 2702, 2703, 301, 333,
                    906, 1115, 1150, 1262, 1415,
                    2503, 2607, 2704, 2705,
                  ],
                ],
              },
              true,
              false,
            ],
          },
        },
      },
    },
  },
  {
    $addFields: {
      rifCedula: "$_id.rifCedula",
      fechaProceso: "$_id.fechaProceso",
      _id: "$$REMOVE",
    },
  },
  {
    $merge: {
      into: "Margenmetric",
      on: ["rifCedula", "fechaProceso"],
      whenMatched: "merge",
      whenNotMatched: "discard",
    },
  },
]

//n8n

[
  {
    "$match": {
      "$expr": {
        "$eq": [
          "$mcl_fecha_proceso", {
            "$toDate": "{{$json.fechaProceso}}"
          }
        ]
      }, 
      "mcl_banca": {
        "$nin": [
          "0", "4", "5", 0, 4, 5
        ]
      }, 
      "sidisProducto.prd_codigo_producto": {
        "$in": [
          1117, 1140, 1106, 1136, 1406, 200, 1111, 1197, 1404, 100, 819, 805, 1133, 113, 198, 1414, 1405, 1408, 1122, 108, 9502, 9501, 101, 1407, 9506, 1190, 1114, 1330, 1170, 197, 210, 1310, 1112, 1410, 106, 1160, 1401, 1121, 1360, 381, 1350, 280, 1316, 2701, 1390, 2601, 329, 1320, 107, 208, 1380, 1152, 1134, 5329, 2501, 325, 316, 1315, 851, 1340, 1123, 120, 313, 1264, 203, 1341, 861, 2401, 211, 2402, 852, 809, 196, 202, 324, 1131, 206, 853, 311, 860, 808, 201, 1416, 858, 205, 530, 2608, 364, 2502, 1105, 9509, 315, 730, 308, 1104, 1113, 1268, 2603, 2702, 2703, 301, 333, 906, 1115, 1150, 1262, 1415, 2503, 2607, 2704, 2705, 102, 103, 104, 105, 109, 110, 111, 112, 199, 204, 207, 209, 215, 300, 302, 303, 304, 305, 306, 307, 309, 310, 312, 314, 317, 318, 319, 320, 321, 322, 323, 326, 327, 328, 330, 331, 332, 334, 335, 336, 337, 338, 339, 340, 341, 342, 343, 344, 345, 346, 347, 348, 349, 350, 351, 352, 353, 354, 355, 356, 357, 358, 359, 360, 361, 362, 363, 365, 366, 367, 368, 369, 370, 371, 372, 373, 374, 375, 376, 377, 378, 379, 380, 383, 386, 388, 393, 394, 395, 396, 397, 398, 399, 401, 402, 404, 410, 412, 414, 416, 511, 512, 520, 521, 522, 526, 527, 529, 532, 534, 535, 550, 556, 558, 559, 561, 563, 570, 571, 572, 595, 600, 601, 602, 603, 604, 605, 607, 608, 609, 610, 611, 612, 699, 700, 701, 703, 731, 800, 801, 802, 803, 804, 806, 807, 810, 811, 812, 813, 814, 815, 816, 817, 818, 820, 821, 822, 823, 824, 825, 826, 827, 854, 855, 856, 857, 859, 887, 899, 902, 904, 905, 907, 908, 909, 910, 911, 912, 1101, 1103, 1107, 1108, 1109, 1110, 1116, 1118, 1119, 1120, 1124, 1125, 1126, 1127, 1128, 1129, 1130, 1132, 1135, 1141, 1142, 1180, 1191, 1192, 1199, 1261, 1263, 1265, 1266, 1267, 1269, 1270, 1271, 1272, 1273, 1274, 1275, 1277, 1278, 1279, 1280, 1301, 1307, 1317, 1322, 1323, 1324, 1400, 1402, 1403, 1501, 1502, 1503, 1506, 1507, 1508, 2064, 2070, 2071, 2100, 2101, 2102, 2200, 2201, 2202, 2300, 2301, 2302, 2324, 2403, 2504, 2606, 2609, 3300, 3301, 3302, 3384, 3385, 3394, 3395, 3404, 3405, 4301, 4302, 4304, 4305, 4308, 4309, 4311, 4312, 4313, 4314, 4315, 4316, 4320, 4321, 4323, 4324, 4325, 4328, 4329, 4333, 4334, 4364, 4383, 8887, 8888, 8890, 8891, 9503, 9504, 9507, 9508, 9510, 9998
        ]
      }
    }
  }, {
    "$project": {
      "rifCedula": "$mcl_rif_cedula", 
      "fechaProceso": "$mcl_fecha_proceso", 
      "productName": "$sidisProducto.prd_nombre_producto", 
      "productCode": "$sidisProducto.prd_codigo_producto", 
      "_id": 0
    }
  }, {
    "$group": {
      "_id": {
        "rifCedula": "$rifCedula", 
        "fechaProceso": "$fechaProceso"
      }, 
      "relatedProducts": {
        "$addToSet": {
          "name": "$productName", 
          "lastUse": "$fechaProceso", 
          "code": "$productCode", 
          "active": {
            "$cond": [
              {
                "$in": [
                  "$productCode", [
                    1117, 1140, 1106, 1136, 1406, 200, 1111, 1197, 1404, 100, 819, 805, 1133, 113, 198, 1414, 1405, 1408, 1122, 108, 9502, 9501, 101, 1407, 9506, 1190, 1114, 1330, 1170, 197, 210, 1310, 1112, 1410, 106, 1160, 1401, 1121, 1360, 381, 1350, 280, 1316, 2701, 1390, 2601, 329, 1320, 107, 208, 1380, 1152, 1134, 5329, 2501, 325, 316, 1315, 851, 1340, 1123, 120, 313, 1264, 203, 1341, 861, 2401, 211, 2402, 852, 809, 196, 202, 324, 1131, 206, 853, 311, 860, 808, 201, 1416, 858, 205, 530, 2608, 364, 2502, 1105, 9509, 315, 730, 308, 1104, 1113, 1268, 2603, 2702, 2703, 301, 333, 906, 1115, 1150, 1262, 1415, 2503, 2607, 2704, 2705
                  ]
                ]
              }, true, false
            ]
          }
        }
      }
    }
  }, {
    "$addFields": {
      "rifCedula": "$_id.rifCedula", 
      "fechaProceso": "$_id.fechaProceso", 
      "_id": "$$REMOVE"
    }
  }, {
    "$merge": {
      "into": "Margenmetric", 
      "on": [
        "rifCedula", "fechaProceso"
      ], 
      "whenMatched": "merge", 
      "whenNotMatched": "discard"
    }
  }
]