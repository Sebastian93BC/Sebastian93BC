[
    "[\n{\n\"$match\":{\n\"$and\":[\n{\n\"$expr\":{\n\"$eq\":[\n\"$fechaProceso\",\n{\n\"$toDate\":\"2023-11-30\"\n}\n]\n}\n}\n]\n}\n},\n{\n\"$group\":{\n\"_id\":{\n\"fechaProceso\":\"$fechaProceso\",\n\"tra_fecha_operacion\":\"$tra_fecha_operacion\"\n},\n\"baseCollectionCount\":{\n\"$sum\":1\n}\n}\n},\n{\n\"$group\":{\n\"_id\":{\n\"fechaProceso\":\"$_id.fechaProceso\"\n},\n\"results\":{\n\"$addToSet\":{\n\"date\":\"$_id.tra_fecha_operacion\",\n\"count\":\"$baseCollectionCount\"\n}\n}\n}\n},\n{\n\"$addFields\":{\n\"processDate\":\"$_id.fechaProceso\",\n\"recipeCode\":\"T00\",\n\"updatedAt\":\"$$NOW\",\n\"processName\":\"TransaferenciaTransacciones\",\n\"kpi\":[\n{\n\"name\":\"Transacciones\",\n\"tra_fecha_operacion\":\"$_id.tra_fecha_operacion\",\n\"toCollectionCount\":\"$results\",\n\"baseCollection\":\"rawTransacciones\",\n\"toCollection\":\"sidis_transacciones\"\n}\n],\n\"_id\":\"$$REMOVE\",\n\"results\":\"$$REMOVE\"\n}\n},\n{\n\"$lookup\":{\n\"from\":\"sidis_consistencyData\",\n\"let\":{\n\"fechaProcesoLookup\":\"$processDate\",\n\"codeLookup\":\"$recipeCode\"\n},\n\"pipeline\":[\n{\n\"$match\":{\n\"$expr\":{\n\"$and\":[\n{\n\"$eq\":[\n\"$processDate\",\n\"$$fechaProcesoLookup\"\n]\n},\n{\n\"$eq\":[\n\"$recipeCode\",\n\"$$codeLookup\"\n]\n}\n]\n}\n}\n},\n{\n\"$project\":{\n\"kpi\":1\n}\n}\n],\n\"as\":\"resultados\"\n}\n},\n{\n\"$unwind\":{\n\"path\":\"$resultados\"\n}\n},\n{\n\"$addFields\":{\n\"found\":{\n\"$filter\":{\n\"input\":\"$resultados.kpi\",\n\"as\":\"arregloSecundario\",\n\"cond\":{\n\"$eq\":[\n\"Transacciones\",\n\"$$arregloSecundario.name\"\n]\n}\n}\n}\n}\n},\n{\n\"$addFields\":{\n\"resultados\":{\n\"$concatArrays\":[\n\"$resultados.kpi\",\n\"$kpi\"\n]\n}\n}\n},\n{\n\"$project\":{\n\"processDate\":1,\n\"recipeCode\":1,\n\"updatedAt\":\"$$NOW\",\n\"kpi\":\"$resultados\",\n\"_id\":0\n}\n},\n{\n\"$merge\":{\n\"into\":\"sidis_consistencyData\",\n\"on\":[\n\"processDate\",\n\"recipeCode\"\n]\n}\n}\n]"
]