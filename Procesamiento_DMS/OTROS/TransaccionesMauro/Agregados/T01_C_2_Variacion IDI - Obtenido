[{"$match":{"$expr":{"$eq":["$fechaProceso",{"$toDate":"@fechaProceso"}]},"variacionIDIBolivares":{"$exists":true}}},{"$group":{"_id":{"fechaProceso":"$fechaProceso"},"rifCedulaList":{"$addToSet":"$rifCedula"}}},{"$addFields":{"countDistinctRif":{"$size":"$rifCedulaList"},"fechaProceso":"$_id.fechaProceso"}},{"$addFields":{"processDate":"$fechaProceso","kpi":{"name":"Variacion IDI","toCollectionCount":"$countDistinctRif","toCollection":"sidis_ingresoCarteraCredito"},"processName":"Ingreso por cartera de credito","recipeCode":"T01","_id":"$$REMOVE","countDistinctRif":"$$REMOVE","fechaProceso":"$$REMOVE","rifCedulaList":"$$REMOVE"}},{"$lookup":{"from":"sidis_consistencyData","let":{"fechaProcesoLookup":"$fechaProceso","codeLookup":"$code"},"pipeline":[{"$match":{"$expr":{"$and":[{"$eq":["$fechaProceso","$$fechaProcesoLookup"]},{"$eq":["$code","$$codeLookup"]}]}}},{"$project":{"kpi":1}}],"as":"resultados"}},{"$unwind":{"path":"$resultados"}},{"$addFields":{"found":{"$filter":{"input":"$resultados.kpi","as":"arregloSecundario","cond":{"$eq":["Variacion IDI","$$arregloSecundario.name"]}}}}},{"$unwind":{"path":"$resultados.kpi"}},{"$addFields":{"resultados.kpi.toCollectionCount":{"$cond":[{"$and":[{"$eq":["$kpi.name","Variacion IDI"]},{"$eq":["$resultados.kpi.name","Variacion IDI"]}]},"$kpi.toCollectionCount","$resultados.kpi.toCollectionCount"]}}},{"$addFields":{"resultados.kpi.result":{"$cond":[{"$eq":["$resultados.kpi.baseCollectionCount","$resultados.kpi.toCollectionCount"]},true,false]},"found":"$$REMOVE","kpi":"$$REMOVE"}},{"$group":{"_id":{"processDate":"$processDate","processName":"$processName","recipeCode":"$recipeCode"},"kpi":{"$addToSet":"$resultados.kpi"}}},{"$project":{"processDate":"$_id.processDate","recipeCode":"$_id.recipeCode","updatedAt":"$$NOW","kpi":1,"_id":0}},{"$merge":{"into":"sidis_consistencyData","on":["processDate","recipeCode"]}}]