[
    {
        "$match": {
            "$expr": {
                "$eq": [
                    "$fechaProceso",
                    {
                        "$toDate": "2024-02-29"
                    }
                ]
            },
            "tra_cod_op": {
                "$in": [
                    6513,
                    8540,
                    9780,
                    6512,
                    1436,
                    4008,
                    3652,
                    1436,
                    4008,
                    3652,
                    9162,
                    9733,
                    4025,
                    7602,
                    8926,
                    4659,
                    1328
                ]
            }
        }
    },
    {
        "$project": {
            "tra_rif": 1,
            "tra_fecha_contable": 1,
            "tra_cod_op": 1,
            "tra_ind_cre_deb": 1
        }
    },
    {
        "$addFields": {
            "fechaProceso": {
                "$dateFromParts": {
                    "year": {
                        "$year": "$tra_fecha_contable"
                    },
                    "month": {
                        "$add": [
                            {
                                "$month": "$tra_fecha_contable"
                            },
                            1
                        ]
                    },
                    "day": {
                        "$subtract": [
                            {
                                "$dayOfMonth": {
                                    "$dateFromParts": {
                                        "year": {
                                            "$year": "$tra_fecha_contable"
                                        },
                                        "month": {
                                            "$add": [
                                                {
                                                    "$month": "$tra_fecha_contable"
                                                },
                                                1
                                            ]
                                        },
                                        "day": 1
                                    }
                                }
                            },
                            1
                        ]
                    },
                    "hour": 0,
                    "minute": 0,
                    "second": 0,
                    "millisecond": 0
                }
            }
        }
    },
    {
        "$group": {
            "_id": {
                "rif": "$tra_rif",
                "fechaProceso": "$fechaProceso"
            },
            "countPagoProveedores": {
                "$sum": {
                    "$cond": {
                        "if": {
                            "$in": [
                                "$tra_cod_op",
                                [
                                    6513,
                                    8540,
                                    9780
                                ]
                            ]
                        },
                        "then": 1,
                        "else": 0
                    }
                }
            },
            "countNomina": {
                "$sum": {
                    "$cond": {
                        "if": {
                            "$in": [
                                "$tra_cod_op",
                                [
                                    6512
                                ]
                            ]
                        },
                        "then": 1,
                        "else": 0
                    }
                }
            },
            "countPagoMovil": {
                "$sum": {
                    "$cond": {
                        "if": {
                            "$in": [
                                "$tra_cod_op",
                                [
                                    1436,
                                    4008,
                                    3652
                                ]
                            ]
                        },
                        "then": 1,
                        "else": 0
                    }
                }
            },
            "countIntervencionBancaria": {
                "$sum": {
                    "$cond": {
                        "if": {
                            "$in": [
                                "$tra_cod_op",
                                [
                                    9162,
                                    9733
                                ]
                            ]
                        },
                        "then": 1,
                        "else": 0
                    }
                }
            },
            "countMesaCambio": {
                "$sum": {
                    "$cond": {
                        "if": {
                            "$in": [
                                "$tra_cod_op",
                                [
                                    4025,
                                    7602,
                                    8926
                                ]
                            ]
                        },
                        "then": 1,
                        "else": 0
                    }
                }
            }
        }
    },
    {
        "$addFields": {
            "rifCedula": "$_id.rif",
            "fechaProceso": "$_id.fechaProceso"
        }
    },
    {
        "$project": {
            "_id": 0
        }
    },
    {
        "$addFields": {
            "pagoProveedores": {
                "$cond": {
                    "if": {
                        "$gt": [
                            "$countPagoProveedores",
                            0
                        ]
                    },
                    "then": 1,
                    "else": 0
                }
            },
            "nomina": {
                "$cond": {
                    "if": {
                        "$gt": [
                            "$countNomina",
                            0
                        ]
                    },
                    "then": 1,
                    "else": 0
                }
            },
            "pagoMovil": {
                "$cond": {
                    "if": {
                        "$gt": [
                            "$countPagoMovil",
                            0
                        ]
                    },
                    "then": 1,
                    "else": 0
                }
            },
            "intervencionBancaria": {
                "$cond": {
                    "if": {
                        "$gt": [
                            "$countIntervencionBancaria",
                            0
                        ]
                    },
                    "then": 1,
                    "else": 0
                }
            },
            "mesaCambio": {
                "$cond": {
                    "if": {
                        "$gt": [
                            "$countMesaCambio",
                            0
                        ]
                    },
                    "then": 1,
                    "else": 0
                }
            }
        }
    },
    {
        "$project": {
            "countPagoProveedores": 0,
            "countNomina": 0,
            "countPagoMovil": 0,
            "countIntervencionBancaria": 0,
            "countMesaCambio": 0
        }
    },
    {
        "$merge": {
            "into": "sidis_productosVinculados",
            "on": [
                "fechaProceso",
                "rifCedula"
            ]
        }
    }
]